<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard GKI Kutisari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .modal {
        transition: opacity 0.25s ease;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div id="login-screen" class="flex items-center justify-center h-screen">
      <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-center text-gray-800">
          Login ke Dashboard GKI Kutisari
        </h2>
        <form id="login-form">
          <div class="space-y-4">
            <div>
              <label for="email" class="text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                id="email"
                type="email"
                required
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                value="harisgay@gmail.com"
              />
            </div>
            <div>
              <label for="password" class="text-sm font-medium text-gray-700"
                >Password</label
              >
              <input
                id="password"
                type="password"
                required
                class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                value="123"
              />
            </div>
          </div>
          <button
            type="submit"
            class="w-full px-4 py-2 mt-6 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700"
          >
            Login
          </button>
          <p
            id="login-feedback"
            class="mt-2 text-sm text-center text-red-600"
          ></p>
        </form>
      </div>
    </div>

    <div id="app-layout" class="hidden">
      <div class="relative min-h-screen md:flex">
        <div
          id="sidebar"
          class="fixed inset-y-0 left-0 w-64 bg-gray-800 text-white flex flex-col transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30"
        >
          <div class="flex items-center px-8 py-6">
            <img src="logo.png" alt="Logo GKI Kutisari" class="h-8 w-8 mr-2" />
            <span class="text-xl font-bold">GKI Kutisari</span>
          </div>
          <nav class="flex-1 px-4 py-4 space-y-2">
            <a
              href="#dashboard"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-tachometer-alt w-6"></i> Dashboard
            </a>
            <a
              href="#barang"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-boxes w-6"></i> Barang
            </a>
            <a
              href="#ruangan"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-building w-6"></i> Ruangan
            </a>
            <a
              href="#user-management"
              id="management-link"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 hidden"
            >
              <i class="fas fa-users-cog w-6"></i> User Management
            </a>
          </nav>
          <div class="p-4 border-t border-gray-700 md:hidden">
            <button
              id="close-sidebar-button"
              class="flex items-center w-full px-4 py-2 text-left rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-times w-6"></i> Tutup Menu
            </button>
          </div>
          <div class="px-4 py-4">
            <a
              href="#"
              id="logout-button"
              class="flex items-center w-full px-4 py-2 text-left rounded-md hover:bg-gray-700"
              ><i class="fas fa-sign-out-alt w-6"></i> Logout</a
            >
          </div>
        </div>
        <div
          id="sidebar-overlay"
          class="fixed inset-0 bg-black opacity-50 hidden z-20"
        ></div>
        <main class="flex-1 p-10 overflow-y-auto">
          <button
            id="hamburger-button"
            class="md:hidden fixed top-4 left-4 z-10 p-2 bg-gray-800 text-white rounded-md"
          >
            <i class="fas fa-bars"></i>
          </button>
          <div id="content-area"></div>
        </main>
      </div>
    </div>

    <template id="dashboard-template">
      <div id="manager-dashboard-content" class="hidden"></div>
      <div id="member-dashboard-content" class="hidden"></div>
    </template>

    <template id="barang-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Peminjaman Barang</h1>
      <div id="barang-content-area">
        <p>Memuat data barang...</p>
      </div>
    </template>

    <template id="ruangan-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Reservasi Ruangan</h1>
      <div id="ruangan-content-area">
        <p>Memuat data ruangan...</p>
      </div>
    </template>

    <template id="user-management-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Manajemen Pengguna</h1>
      <div id="user-management-content-area">
        <p>Memuat data pengguna...</p>
      </div>
    </template>

    <script>
      // =====================================================================
      //          LOGIKA JAVASCRIPT BARU (REVISI BESAR)
      // =====================================================================

      // === STATE & KONFIGURASI ===
      const contentArea = document.getElementById("content-area");
      const loginScreen = document.getElementById("login-screen");
      const appLayout = document.getElementById("app-layout");
      const managementLink = document.getElementById("management-link");
      const sidebar = document.getElementById("sidebar");
      const hamburgerButton = document.getElementById("hamburger-button");
      const closeSidebarButton = document.getElementById(
        "close-sidebar-button"
      );
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      let fullCalendarInstance; // Global variable for FullCalendar

      // === API HELPER (TIDAK BERUBAH) ===
      const api = {
        async _fetch(endpoint, method = "GET", body = null) {
          const token = localStorage.getItem("authToken");
          const options = {
            method,
            headers: { Authorization: `Bearer ${token}` },
          };
          if (body) {
            options.headers["Content-Type"] = "application/json";
            options.body = JSON.stringify(body);
          }
          const response = await fetch(endpoint, options);
          if (response.status === 401) {
            logout();
            return Promise.reject(new Error("Unauthorized"));
          }
          if (response.status === 204) {
            return null;
          }
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "Terjadi kesalahan pada server.");
          }
          return data;
        },
        get(endpoint) {
          return this._fetch(endpoint, "GET");
        },
        post(endpoint, body) {
          return this._fetch(endpoint, "POST", body);
        },
        put(endpoint, body) {
          return this._fetch(endpoint, "PUT", body);
        },
        delete(endpoint, body) {
          return this._fetch(endpoint, "DELETE", body);
        },
        async login(email, password) {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error);
          }
          return response.json();
        },
      };

      // === FUNGSI UTAMA (AUTH & NAVIGASI) ===
      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userRole");
        appLayout.classList.add("hidden");
        loginScreen.classList.remove("hidden");
        window.location.hash = "";
      }

      async function handleLogin(e) {
        e.preventDefault();
        const feedback = document.getElementById("login-feedback");
        feedback.textContent = "Mencoba login...";
        try {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const data = await api.login(email, password);

          localStorage.setItem("authToken", data.session.access_token);
          const userRole = data.user.user_metadata.role || "member";
          localStorage.setItem("userRole", userRole);

          loginScreen.classList.add("hidden");
          appLayout.classList.remove("hidden");

          if (userRole === "management") {
            managementLink.classList.remove("hidden");
            window.location.hash = "#dashboard";
          } else {
            window.location.hash = "#dashboard"; // Member juga ke dashboard sekarang
          }
          router();
        } catch (error) {
          feedback.textContent = error.message;
        }
      }

      function toggleSidebar() {
        sidebar.classList.toggle("-translate-x-full");
        sidebarOverlay.classList.toggle("hidden");
      }

      // === ROUTER UTAMA (DIPERBARUI) ===
      function router() {
        if (window.innerWidth < 768) {
          sidebar.classList.add("-translate-x-full");
          sidebarOverlay.classList.add("hidden");
        }
        const hash =
          window.location.hash ||
          (localStorage.getItem("userRole") === "management"
            ? "#dashboard"
            : "#inventaris");

        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.toggle(
            "bg-gray-700",
            link.getAttribute("href") === hash
          );
        });

        contentArea.innerHTML = ""; // Selalu kosongkan konten sebelum memuat yang baru
        switch (hash) {
          case "#dashboard":
            loadDashboardPage();
            break;
          case "#barang":
            // loadBarangPage(); // Akan kita buat nanti
            contentArea.innerHTML =
              "<h1>Halaman Barang (Dalam Pengembangan)</h1>";
            break;
          case "#ruangan":
            // loadRuanganPage(); // Akan kita buat nanti
            contentArea.innerHTML =
              "<h1>Halaman Ruangan (Dalam Pengembangan)</h1>";
            break;
          case "#user-management":
            if (localStorage.getItem("userRole") === "management") {
              // loadUserManagementPage(); // Akan kita buat nanti
              contentArea.innerHTML =
                "<h1>Halaman User Management (Dalam Pengembangan)</h1>";
            } else {
              contentArea.innerHTML = `<h1 class="text-2xl text-red-600">Akses Ditolak</h1>`;
            }
            break;
          default:
            window.location.hash = "#dashboard"; // Arahkan ke dashboard jika hash tidak dikenal
            loadDashboardPage();
        }
      }

      // === FUNGSI PEMUAT HALAMAN (BARU) ===

      // 1. Pemuatan Halaman Dashboard
      async function loadDashboardPage() {
        const template = document
          .getElementById("dashboard-template")
          .content.cloneNode(true);
        contentArea.appendChild(template);
        const userRole = localStorage.getItem("userRole");

        if (userRole === "management") {
          document
            .getElementById("manager-dashboard-content")
            .classList.remove("hidden");
          renderManagerDashboard();
        } else {
          document
            .getElementById("member-dashboard-content")
            .classList.remove("hidden");
          renderMemberDashboard();
        }
      }

      // 2. Render Konten Dashboard untuk Management
      // GANTI DENGAN KODE FUNGSI LENGKAP INI
      async function renderManagerDashboard() {
        const container = document.getElementById("manager-dashboard-content");
        container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Manajemen</h1><p>Memuat data...</p>`;

        try {
          // Panggil kedua API secara paralel untuk efisiensi
          const [stats, pendingRequests] = await Promise.all([
            api.get("/api/dashboard-stats"),
            api.get("/api/management/pending-requests"),
          ]);

          const { pendingAssetLoans, pendingRoomReservations } =
            pendingRequests;

          // Siapkan template HTML untuk seluruh konten dashboard admin
          let contentHTML = `
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Manajemen</h1>

            <h2 class="text-xl font-semibold text-gray-700 mb-4">Statistik Aset</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Total Aset</h3><p class="text-3xl font-bold">${stats.totalAssets}</p></div>
                <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Aset Dipinjam</h3><p class="text-3xl font-bold">${stats.borrowedAssets}</p></div>
                <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Dalam Perbaikan</h3><p class="text-3xl font-bold">${stats.maintenanceAssets}</p></div>
            </div>

            <h2 class="text-xl font-semibold text-gray-700 mb-4">Statistik Ruangan</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Total Ruangan</h3><p class="text-3xl font-bold">${stats.totalRooms}</p></div>
                <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Reservasi Disetujui</h3><p class="text-3xl font-bold">${stats.approvedReservations}</p></div>
                <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Menunggu Persetujuan</h3><p class="text-3xl font-bold">${stats.pendingReservations}</p></div>
            </div>

            <div id="actionable-list-container">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Persetujuan Tertunda</h2>
                <div class="bg-white p-4 rounded-lg shadow-md space-y-4">
        `;

          // Gabungkan dan render daftar permintaan yang pending
          const allPendingRequests = [
            ...pendingAssetLoans.map((item) => ({ ...item, type: "loan" })),
            ...pendingRoomReservations.map((item) => ({
              ...item,
              type: "room",
            })),
          ];

          if (allPendingRequests.length === 0) {
            contentHTML +=
              '<p class="text-gray-500 p-4 text-center">Tidak ada permintaan baru.</p>';
          } else {
            allPendingRequests.forEach((item) => {
              const title =
                item.type === "loan"
                  ? `${item.assets.asset_name}`
                  : `${item.event_name} (${item.room_name})`;
              const requester =
                item.type === "loan"
                  ? item.profiles.full_name
                  : item.requester_name;
              const time =
                item.type === "loan"
                  ? new Date(item.loan_date).toLocaleDateString("id-ID")
                  : new Date(item.start_time).toLocaleString("id-ID");

              contentHTML += `
                    <div class="flex items-center justify-between p-4 border rounded-md">
                        <div>
                            <p class="font-semibold">${title}</p>
                            <p class="text-sm text-gray-600">Oleh: ${requester} | Diajukan: ${time}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${item.id}" data-type="${item.type}" data-action="Disetujui" class="admin-action-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded">Setujui</button>
                            <button data-id="${item.id}" data-type="${item.type}" data-action="Ditolak" class="admin-action-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded">Tolak</button>
                        </div>
                    </div>
                `;
            });
          }

          contentHTML += `</div></div>`; // Tutup div untuk daftar tugas dan container
          container.innerHTML = contentHTML; // Masukkan semua HTML yang sudah jadi ke container

          // Tambahkan event listener untuk semua tombol aksi admin
          document.querySelectorAll(".admin-action-btn").forEach((button) => {
            button.addEventListener("click", handleAdminAction);
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat data dashboard: ${error.message}</p>`;
        }
      }

      // 3. Render Konten Dashboard untuk Member
      async function renderMemberDashboard() {
        const container = document.getElementById("member-dashboard-content");
        container.innerHTML = `
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Status Permintaan Saya</h1>
    <div id="my-requests-list" class="space-y-4">
      <p>Memuat data permintaan...</p>
    </div>
  `;
        const listContainer = document.getElementById("my-requests-list");
        try {
          const { assetLoans, roomReservations } = await api.get(
            "/api/dashboard/my-requests"
          );
          listContainer.innerHTML = "";

          // Render Peminjaman Aset
          listContainer.innerHTML +=
            '<h2 class="text-xl font-semibold mt-4">Peminjaman Barang</h2>';
          if (assetLoans.length > 0) {
            assetLoans.forEach((item) => {
              const statusColor =
                item.status === "Disetujui"
                  ? "text-green-600"
                  : item.status === "Ditolak"
                  ? "text-red-600"
                  : "text-yellow-600";
              const itemDiv = document.createElement("div");
              itemDiv.className =
                "bg-white p-4 rounded-lg shadow-md flex justify-between items-center";
              itemDiv.innerHTML = `
              <div>
                <p class="font-bold">${item.assets.asset_name}</p>
                <p class="text-sm ${statusColor}">${item.status}</p>
              </div>
              ${
                item.status === "Menunggu Persetujuan"
                  ? `<button data-id="${item.id}" data-type="asset" class="cancel-btn bg-gray-500 text-white py-1 px-3 rounded hover:bg-gray-600">Batalkan</button>`
                  : ""
              }
            `;
              listContainer.appendChild(itemDiv);
            });
          } else {
            listContainer.innerHTML +=
              '<p class="text-gray-500">Tidak ada riwayat peminjaman barang.</p>';
          }

          // Render Reservasi Ruangan
          listContainer.innerHTML +=
            '<h2 class="text-xl font-semibold mt-6">Reservasi Ruangan</h2>';
          if (roomReservations.length > 0) {
            roomReservations.forEach((item) => {
              const statusColor =
                item.status === "Disetujui"
                  ? "text-green-600"
                  : item.status === "Ditolak"
                  ? "text-red-600"
                  : "text-yellow-600";
              const itemDiv = document.createElement("div");
              itemDiv.className =
                "bg-white p-4 rounded-lg shadow-md flex justify-between items-center";
              itemDiv.innerHTML = `
              <div>
                <p class="font-bold">${item.event_name} (${item.room_name})</p>
                <p class="text-sm ${statusColor}">${item.status}</p>
              </div>
              ${
                item.status === "Menunggu Persetujuan"
                  ? `<button data-id="${item.id}" data-type="room" class="cancel-btn bg-gray-500 text-white py-1 px-3 rounded hover:bg-gray-600">Batalkan</button>`
                  : ""
              }
            `;
              listContainer.appendChild(itemDiv);
            });
          } else {
            listContainer.innerHTML +=
              '<p class="text-gray-500">Tidak ada riwayat reservasi ruangan.</p>';
          }

          // Tambahkan event listener untuk tombol batal
          document
            .querySelectorAll(".cancel-btn")
            .forEach((btn) =>
              btn.addEventListener("click", handleCancelRequest)
            );
        } catch (error) {
          listContainer.innerHTML = `<p class="text-red-500">Gagal memuat data: ${error.message}</p>`;
        }
      }

      // BARU: Fungsi untuk menangani aksi admin (Setujui/Tolak)
      async function handleAdminAction(e) {
        const button = e.target;
        const id = button.dataset.id;
        const type = button.dataset.type; // 'loan' atau 'room'
        const action = button.dataset.action; // 'Disetujui' atau 'Ditolak'

        if (
          !confirm(
            `Apakah Anda yakin ingin mengubah status permintaan ini menjadi "${action}"?`
          )
        )
          return;

        button.disabled = true;
        button.textContent = "Memproses...";

        try {
          // Tentukan API endpoint yang akan dipanggil berdasarkan tipe permintaan
          const endpoint =
            type === "loan"
              ? "/api/management/update-loan-status"
              : "/api/management/update-reservation-status";

          const payload =
            type === "loan"
              ? { loanId: id, newStatus: action }
              : { reservationId: id, newStatus: action };

          await api.post(endpoint, payload);
          alert("Status permintaan berhasil diperbarui.");
          loadDashboardPage(); // Muat ulang data dashboard
        } catch (error) {
          alert(`Gagal memperbarui: ${error.message}`);
          button.disabled = false;
          button.textContent = action;
        }
      }
      // 4. Fungsi untuk menangani Aksi Pembatalan oleh Member
      async function handleCancelRequest(e) {
        const button = e.target;
        const id = button.dataset.id;
        const type = button.dataset.type;

        if (!confirm("Apakah Anda yakin ingin membatalkan permintaan ini?"))
          return;

        button.disabled = true;
        button.textContent = "Memproses...";

        try {
          await api.post("/api/requests/cancel", {
            requestId: id,
            requestType: type,
          });
          alert("Permintaan berhasil dibatalkan.");
          loadDashboardPage(); // Muat ulang dashboard
        } catch (error) {
          alert(`Gagal membatalkan: ${error.message}`);
          button.disabled = false;
          button.textContent = "Batalkan";
        }
      }

      // TODO: Buat fungsi loadBarangPage(), loadRuanganPage(), loadUserManagementPage() nanti.

      // === EVENT LISTENERS (di bagian akhir skrip) ===
      document
        .getElementById("login-form")
        .addEventListener("submit", handleLogin);
      document
        .getElementById("logout-button")
        .addEventListener("click", logout);
      window.addEventListener("hashchange", router);

      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("authToken")) {
          loginScreen.classList.add("hidden");
          appLayout.classList.remove("hidden");
          if (localStorage.getItem("userRole") === "management") {
            managementLink.classList.remove("hidden");
          }
          router();
        }
        hamburgerButton.addEventListener("click", toggleSidebar);
        closeSidebarButton.addEventListener("click", toggleSidebar);
        sidebarOverlay.addEventListener("click", toggleSidebar);
      });
    </script>
  </body>
</html>
