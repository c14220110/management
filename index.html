<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard GKI Kutisari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* CSS Loader & App Layout (Tidak Berubah) */
      .modal {
        transition: opacity 0.25s ease;
      }
      #page-loader {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 200; /* Pastikan loader di atas semua elemen */
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .loader-hidden {
        opacity: 0;
        visibility: hidden;
      }
      .loader-visible {
        opacity: 1;
        visibility: visible;
      }
      #page-loader svg {
        overflow: visible;
        width: 100px;
        height: 150px;
      }
      #page-loader svg g {
        animation: slide 2s linear infinite;
      }
      #page-loader svg g:nth-child(2) {
        animation-delay: 0.5s;
      }
      #page-loader svg g:nth-child(2) path {
        animation-delay: 0.5s;
        stroke-dasharray: 0px 158px;
        stroke-dashoffset: 1px;
      }
      #page-loader svg path {
        stroke: url(#gradient);
        stroke-width: 20px;
        stroke-linecap: round;
        fill: none;
        stroke-dasharray: 0 157px;
        stroke-dashoffset: 0;
        animation: escalade 2s cubic-bezier(0.8, 0, 0.2, 1) infinite;
      }
      .loading-text {
        margin-top: 20px;
        color: #d97706; /* amber-600 */
        font-size: 16px;
        font-weight: 500;
        opacity: 0.8;
        animation: pulse 2s ease-in-out infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 0.8;
        }
        50% {
          opacity: 0.4;
        }
      }
      @keyframes slide {
        0% {
          transform: translateY(-50px);
        }
        100% {
          transform: translateY(50px);
        }
      }
      @keyframes escalade {
        0% {
          stroke-dasharray: 0 157px;
          stroke-dashoffset: 0;
        }
        50% {
          stroke-dasharray: 157px 157px;
          stroke-dashoffset: 0;
        }
        100% {
          stroke-dasharray: 157px 157px;
          stroke-dashoffset: -156px;
        }
      }

      /* CSS BARU UNTUK TAMPILAN LOGIN */
      #login-screen {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        position: relative;
      }
      .bg-animation {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }
      .floating-circle {
        position: absolute;
        background: linear-gradient(45deg, #d97706, #f59e0b);
        border-radius: 50%;
        opacity: 0.1;
        animation: float 6s ease-in-out infinite;
      }
      .circle-1 {
        width: 80px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
      }
      .circle-2 {
        width: 120px;
        height: 120px;
        top: 60%;
        right: 15%;
        animation-delay: 2s;
      }
      .circle-3 {
        width: 60px;
        height: 60px;
        bottom: 20%;
        left: 20%;
        animation-delay: 4s;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-20px) rotate(180deg);
        }
      }

      .login-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1),
          0 0 0 1px rgba(255, 255, 255, 0.2);
        width: 100%;
        max-width: 400px;
        position: relative;
        z-index: 2;
        overflow: hidden;
        animation: containerSlideIn 1s ease-out;
      }
      @keyframes containerSlideIn {
        0% {
          opacity: 0;
          transform: translateY(50px) scale(0.9);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .login-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(217, 119, 6, 0.1),
          transparent
        );
        animation: shimmer 3s infinite;
      }
      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .logo-container {
        text-align: center;
        margin-bottom: 30px;
        animation: logoFadeIn 1.5s ease-out;
      }
      @keyframes logoFadeIn {
        0% {
          opacity: 0;
          transform: translateY(-20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #d97706, #f59e0b);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: bold;
        box-shadow: 0 10px 30px rgba(217, 119, 6, 0.3);
        animation: logoGlow 2s ease-in-out infinite alternate;
        transition: transform 0.3s ease;
      }
      .logo:hover {
        transform: scale(1.1) rotate(5deg);
      }
      @keyframes logoGlow {
        0% {
          box-shadow: 0 10px 30px rgba(217, 119, 6, 0.3);
        }
        100% {
          box-shadow: 0 15px 40px rgba(217, 119, 6, 0.5);
        }
      }

      .title {
        color: #1f2937;
        font-size: 22px;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
        animation: titleSlideIn 1.5s ease-out 0.3s both;
      }
      @keyframes titleSlideIn {
        0% {
          opacity: 0;
          transform: translateX(-30px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .form-group {
        margin-bottom: 25px;
        position: relative;
        animation: formSlideIn 1.5s ease-out both;
      }
      .form-group:nth-child(2) {
        animation-delay: 0.5s;
      }
      .form-group:nth-child(3) {
        animation-delay: 0.7s;
      }
      @keyframes formSlideIn {
        0% {
          opacity: 0;
          transform: translateY(20px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group label {
        display: block;
        color: #1f2937;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
        transition: color 0.3s ease;
      }
      .input-container {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
      }
      .form-group input {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.8);
        position: relative;
        z-index: 2;
      }
      .form-group input:focus {
        outline: none;
        border-color: #d97706;
        box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.1),
          0 0 20px rgba(217, 119, 6, 0.3);
        transform: translateY(-2px);
      }

      .login-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #d97706, #f59e0b);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        animation: buttonSlideIn 1.5s ease-out 0.9s both;
      }
      @keyframes buttonSlideIn {
        0% {
          opacity: 0;
          transform: translateY(30px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .login-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(217, 119, 6, 0.4);
      }
      .login-btn:active {
        transform: translateY(-1px);
      }
      .login-btn span {
        position: relative;
        z-index: 1;
      }

      #login-feedback {
        animation: formSlideIn 1.5s ease-out 1.1s both;
      }

      @media (max-width: 480px) {
        .login-container {
          margin: 20px;
          padding: 30px;
        }
        .title {
          font-size: 20px;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Loader -->
    <div id="page-loader" class="loader-hidden">
      <svg>
        <g><path d="M 50,100 A 1,1 0 0 1 50,0" /></g>
        <g><path d="M 50,75 A 1,1 0 0 0 50,-25" /></g>
        <defs>
          <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color: #1f2937; stop-opacity: 1" />
            <stop offset="100%" style="stop-color: #d97706; stop-opacity: 1" />
          </linearGradient>
        </defs>
      </svg>
      <div class="loading-text">Sedang memuat data...</div>
    </div>

    <!-- Tampilan Login Baru -->
    <div id="login-screen">
      <div class="bg-animation">
        <div class="floating-circle circle-1"></div>
        <div class="floating-circle circle-2"></div>
        <div class="floating-circle circle-3"></div>
      </div>
      <div class="login-container">
        <div class="logo-container">
          <div class="logo">GKI</div>
          <h1 class="title">Sistem Informasi GKI Kutisari</h1>
        </div>
        <form id="login-form">
          <div class="form-group">
            <label for="email">Email</label>
            <div class="input-container">
              <input
                type="email"
                id="email"
                name="email"
                required
                value="harisgay@gmail.com"
              />
            </div>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <div class="input-container">
              <input
                type="password"
                id="password"
                name="password"
                required
                value="123"
              />
            </div>
          </div>
          <button type="submit" class="login-btn">
            <span>Login</span>
          </button>
          <p
            id="login-feedback"
            class="mt-4 text-center text-red-700 font-semibold"
          ></p>
        </form>
      </div>
    </div>

    <!-- Layout Aplikasi Utama -->
    <div id="app-layout" class="hidden">
      <div class="relative min-h-screen md:flex">
        <div
          id="sidebar"
          class="fixed inset-y-0 left-0 w-64 bg-gray-800 text-white flex flex-col transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30"
        >
          <div class="flex items-center px-6 py-6">
            <img
              src="logo.png"
              alt="Logo GKI Kutisari"
              class="h-10 w-10 mr-3"
            />
            <span id="user-greeting" class="text-gray-300"></span>
          </div>
          <nav class="flex-1 px-4 py-4 space-y-2">
            <a
              href="#dashboard"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-tachometer-alt w-6"></i> Dashboard
            </a>
            <a
              href="#barang"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-boxes w-6"></i> Barang
            </a>
            <a
              href="#ruangan"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-building w-6"></i> Ruangan
            </a>
            <a
              href="#user-management"
              id="management-link"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 hidden"
            >
              <i class="fas fa-users-cog w-6"></i> User Management
            </a>
          </nav>
          <div class="p-4 border-t border-gray-700 md:hidden">
            <button
              id="close-sidebar-button"
              class="flex items-center w-full px-4 py-2 text-left rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-times w-6"></i> Tutup Menu
            </button>
          </div>
          <div class="px-4 py-4">
            <a
              href="#"
              id="logout-button"
              class="flex items-center w-full px-4 py-2 text-left rounded-md hover:bg-gray-700"
              ><i class="fas fa-sign-out-alt w-6"></i> Logout</a
            >
          </div>
        </div>
        <div
          id="sidebar-overlay"
          class="fixed inset-0 bg-black opacity-50 hidden z-20"
        ></div>
        <main class="flex-1 p-10 overflow-y-auto">
          <button
            id="hamburger-button"
            class="md:hidden fixed top-4 left-4 z-10 p-2 bg-gray-800 text-white rounded-md"
          >
            <i class="fas fa-bars"></i>
          </button>
          <div id="content-area"></div>
        </main>
      </div>
    </div>

    <!-- Templates -->
    <template id="dashboard-template">
      <div id="manager-dashboard-content" class="hidden"></div>
      <div id="member-dashboard-content" class="hidden"></div>
    </template>
    <template id="barang-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Peminjaman Barang</h1>
      <div id="barang-content-area"></div>
    </template>
    <template id="ruangan-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Reservasi Ruangan</h1>
      <div id="ruangan-content-area"></div>
    </template>
    <template id="user-management-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Manajemen Pengguna</h1>
      <div id="user-management-content-area"></div>
    </template>

    <!-- Modals -->
    <div
      id="user-modal"
      class="modal fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
        <h2 id="user-modal-title" class="text-2xl font-bold mb-6"></h2>
        <form id="user-modal-form">
          <input type="hidden" id="user-id" />
          <div class="space-y-4">
            <div>
              <label
                for="user-fullname"
                class="block text-sm font-medium text-gray-700"
                >Nama Lengkap</label
              ><input
                type="text"
                id="user-fullname"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="user-email"
                class="block text-sm font-medium text-gray-700"
                >Email</label
              ><input
                type="email"
                id="user-email"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="user-password"
                class="block text-sm font-medium text-gray-700"
                >Password</label
              ><input
                type="password"
                id="user-password"
                class="w-full p-2 border border-gray-300 rounded-md"
                placeholder="Kosongkan jika tidak ingin diubah"
              />
            </div>
          </div>
          <div class="flex justify-end space-x-4 mt-8">
            <button
              type="button"
              id="user-modal-close"
              class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Batal
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Simpan
            </button>
          </div>
          <p
            id="user-modal-feedback"
            class="mt-4 text-center font-semibold"
          ></p>
        </form>
      </div>
    </div>
    <div
      id="room-modal"
      class="modal fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
        <h2 id="room-modal-title" class="text-2xl font-bold mb-6"></h2>
        <form id="room-modal-form">
          <input type="hidden" id="room-id" />
          <div class="space-y-4">
            <div>
              <label
                for="room-name"
                class="block text-sm font-medium text-gray-700"
                >Nama Ruangan</label
              ><input
                type="text"
                id="room-name"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="room-lokasi"
                class="block text-sm font-medium text-gray-700"
                >Lokasi</label
              ><input
                type="text"
                id="room-lokasi"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="room-kapasitas"
                class="block text-sm font-medium text-gray-700"
                >Kapasitas (Orang)</label
              ><input
                type="number"
                id="room-kapasitas"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="room-penanggung-jawab"
                class="block text-sm font-medium text-gray-700"
                >Penanggung Jawab</label
              ><select
                id="room-penanggung-jawab"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              >
                <option value="">Memuat...</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end space-x-4 mt-8">
            <button
              type="button"
              id="room-modal-close"
              class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Batal
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Simpan
            </button>
          </div>
          <p
            id="room-modal-feedback"
            class="mt-4 text-center font-semibold"
          ></p>
        </form>
      </div>
    </div>

    <script>
      // === STATE & KONFIGURASI ===
      const contentArea = document.getElementById("content-area");
      const loginScreen = document.getElementById("login-screen");
      const appLayout = document.getElementById("app-layout");
      const managementLink = document.getElementById("management-link");
      const sidebar = document.getElementById("sidebar");
      const hamburgerButton = document.getElementById("hamburger-button");
      const closeSidebarButton = document.getElementById(
        "close-sidebar-button"
      );
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      let fullCalendarInstance; // Global variable for FullCalendar
      let managementUserList = [];

      // === API HELPER ===
      const api = {
        async _fetch(endpoint, method = "GET", body = null) {
          const token = localStorage.getItem("authToken");
          const options = {
            method,
            headers: { Authorization: `Bearer ${token}` },
          };
          if (body) {
            options.headers["Content-Type"] = "application/json";
            options.body = JSON.stringify(body);
          }
          const response = await fetch(endpoint, options);
          if (response.status === 401) {
            logout();
            return Promise.reject(new Error("Unauthorized"));
          }
          if (response.status === 204) return null;
          const data = await response.json();
          if (!response.ok)
            throw new Error(data.error || "Terjadi kesalahan pada server.");
          return data;
        },
        get(endpoint) {
          return this._fetch(endpoint, "GET");
        },
        post(endpoint, body) {
          return this._fetch(endpoint, "POST", body);
        },
        put(endpoint, body) {
          return this._fetch(endpoint, "PUT", body);
        },
        delete(endpoint, body) {
          return this._fetch(endpoint, "DELETE", body);
        },
        async login(email, password) {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error);
          }
          return response.json();
        },
      };

      // === LOADER FUNCTIONS ===
      const loader = document.getElementById("page-loader");
      function showLoader() {
        if (loader) {
          loader.classList.remove("loader-hidden");
          loader.classList.add("loader-visible");
        }
      }
      function hideLoader() {
        if (loader) {
          loader.classList.remove("loader-visible");
          loader.classList.add("loader-hidden");
        }
      }

      // === FUNGSI UTAMA (AUTH & NAVIGASI) ===
      function updateUserGreeting() {
        const greetingElement = document.getElementById("user-greeting");
        const userName = localStorage.getItem("userFullName");
        if (greetingElement && userName) {
          greetingElement.innerHTML = `Hi, <strong class="font-bold text-white">${userName}</strong>!`;
        }
      }

      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userRole");
        localStorage.removeItem("userFullName");
        window.location.replace("/");
      }

      async function handleLogin(e) {
        e.preventDefault();
        const feedback = document.getElementById("login-feedback");
        showLoader(); // Tampilkan loader
        feedback.textContent = "";

        try {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const data = await api.login(email, password);

          localStorage.setItem("authToken", data.session.access_token);
          const userRole = data.user.user_metadata.role || "member";
          localStorage.setItem("userRole", userRole);
          localStorage.setItem(
            "userFullName",
            data.user.full_name || data.user.email
          );

          loginScreen.style.display = "none";
          appLayout.classList.remove("hidden");

          if (userRole === "management") {
            managementLink.classList.remove("hidden");
          }
          window.location.hash = "#dashboard";
          router();
        } catch (error) {
          feedback.textContent = error.message;
        } finally {
          hideLoader(); // Sembunyikan loader setelah selesai
        }
      }

      function toggleSidebar() {
        sidebar.classList.toggle("-translate-x-full");
        sidebarOverlay.classList.toggle("hidden");
      }

      // === ROUTER UTAMA ===
      function router() {
        updateUserGreeting();
        if (window.innerWidth < 768) {
          sidebar.classList.add("-translate-x-full");
          sidebarOverlay.classList.add("hidden");
        }
        let hash = window.location.hash;
        if (!hash) {
          if (localStorage.getItem("authToken")) {
            hash = "#dashboard";
            window.location.hash = "#dashboard";
          } else {
            return;
          }
        }

        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.toggle(
            "bg-gray-700",
            link.getAttribute("href") === hash
          );
        });

        contentArea.innerHTML = "";
        switch (hash) {
          case "#dashboard":
            loadDashboardPage();
            break;
          case "#barang":
            loadBarangPage();
            break;
          case "#ruangan":
            loadRuanganPage();
            break;
          case "#user-management":
            if (localStorage.getItem("userRole") === "management") {
              loadUserManagementPage();
            } else {
              contentArea.innerHTML = `<h1 class="text-2xl text-red-600">Akses Ditolak</h1>`;
            }
            break;
          default:
            window.location.hash = "#dashboard";
            loadDashboardPage();
        }
      }

      // === PAGE LOADERS ===
      async function loadDashboardPage() {
        showLoader();
        try {
          const template = document
            .getElementById("dashboard-template")
            .content.cloneNode(true);
          contentArea.innerHTML = "";
          contentArea.appendChild(template);
          const userRole = localStorage.getItem("userRole");
          if (userRole === "management") {
            document
              .getElementById("manager-dashboard-content")
              .classList.remove("hidden");
            await renderManagerDashboard();
          } else {
            document
              .getElementById("member-dashboard-content")
              .classList.remove("hidden");
            await renderMemberDashboard();
          }
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Gagal memuat dashboard: ${error.message}</p>`;
        } finally {
          hideLoader();
        }
      }

      async function renderManagerDashboard() {
        const container = document.getElementById("manager-dashboard-content");
        container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Manajemen</h1><p>Memuat data...</p>`;
        try {
          const [stats, pendingRequests] = await Promise.all([
            api.get("/api/dashboard-stats"),
            api.post("/api/management", { action: "getPendingRequests" }),
          ]);
          const pendingAssetLoans = pendingRequests.pendingAssetLoans ?? [];
          const pendingRoomReservations =
            pendingRequests.pendingRoomReservations ?? [];
          let contentHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Manajemen</h1>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Statistik Aset</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Total Aset</h3><p class="text-3xl font-bold">${stats.totalAssets}</p></div>
                    <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Aset Dipinjam</h3><p class="text-3xl font-bold">${stats.borrowedAssets}</p></div>
                    <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Dalam Perbaikan</h3><p class="text-3xl font-bold">${stats.maintenanceAssets}</p></div>
                </div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Statistik Ruangan</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Total Ruangan</h3><p class="text-3xl font-bold">${stats.totalRooms}</p></div>
                    <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Reservasi Disetujui</h3><p class="text-3xl font-bold">${stats.approvedReservations}</p></div>
                    <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Menunggu Persetujuan</h3><p class="text-3xl font-bold">${stats.pendingReservations}</p></div>
                </div>
                <div id="actionable-list-container">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Persetujuan Tertunda</h2>
                    <div class="bg-white p-4 rounded-lg shadow-md space-y-4">`;
          const allPendingRequests = [
            ...pendingAssetLoans.map((item) => ({ ...item, type: "loan" })),
            ...pendingRoomReservations.map((item) => ({
              ...item,
              type: "room",
            })),
          ];
          if (allPendingRequests.length === 0) {
            contentHTML +=
              '<p class="text-gray-500 p-4 text-center">Tidak ada permintaan baru.</p>';
          } else {
            allPendingRequests.forEach((item) => {
              const title =
                item.type === "loan"
                  ? `${item.assets.asset_name}`
                  : `${item.event_name} (${item.room_name})`;
              const requester =
                item.type === "loan"
                  ? item.profiles.full_name
                  : item.requester_name;
              const time =
                item.type === "loan"
                  ? new Date(item.loan_date).toLocaleDateString("id-ID")
                  : new Date(item.start_time).toLocaleString("id-ID");
              contentHTML += `
                        <div class="flex items-center justify-between p-4 border rounded-md">
                            <div>
                                <p class="font-semibold">${title}</p>
                                <p class="text-sm text-gray-600">Oleh: ${requester} | Diajukan: ${time}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button data-id="${item.id}" data-type="${item.type}" data-action="Disetujui" class="admin-action-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded">Setujui</button>
                                <button data-id="${item.id}" data-type="${item.type}" data-action="Ditolak" class="admin-action-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded">Tolak</button>
                            </div>
                        </div>`;
            });
          }
          contentHTML += `</div></div>`;
          container.innerHTML = contentHTML;
          document
            .querySelectorAll(".admin-action-btn")
            .forEach((button) =>
              button.addEventListener("click", handleAdminAction)
            );
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat data dashboard: ${error.message}</p>`;
        }
      }

      async function renderMemberDashboard() {
        const container = document.getElementById("member-dashboard-content");
        container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Status Permintaan Saya</h1><div id="my-requests-list" class="space-y-4"><p>Memuat data permintaan...</p></div>`;
        const listContainer = document.getElementById("my-requests-list");
        try {
          const { assetLoans, roomReservations } = await api.get(
            "/api/dashboard/my-requests"
          );
          listContainer.innerHTML = "";
          listContainer.innerHTML +=
            '<h2 class="text-xl font-semibold mt-4">Peminjaman Barang</h2>';
          if (assetLoans.length > 0) {
            assetLoans.forEach((item) => {
              const statusColor =
                item.status === "Disetujui"
                  ? "text-green-600"
                  : item.status === "Ditolak"
                  ? "text-red-600"
                  : "text-yellow-600";
              const itemDiv = document.createElement("div");
              itemDiv.className =
                "bg-white p-4 rounded-lg shadow-md flex justify-between items-center";
              itemDiv.innerHTML = `<div><p class="font-bold">${
                item.assets.asset_name
              }</p><p class="text-sm ${statusColor}">${item.status}</p></div>
                        ${
                          item.status === "Menunggu Persetujuan"
                            ? `<button data-id="${item.id}" data-type="asset" class="cancel-btn bg-gray-500 text-white py-1 px-3 rounded hover:bg-gray-600">Batalkan</button>`
                            : ""
                        }`;
              listContainer.appendChild(itemDiv);
            });
          } else {
            listContainer.innerHTML +=
              '<p class="text-gray-500">Tidak ada riwayat peminjaman barang.</p>';
          }
          listContainer.innerHTML +=
            '<h2 class="text-xl font-semibold mt-6">Reservasi Ruangan</h2>';
          if (roomReservations.length > 0) {
            roomReservations.forEach((item) => {
              const statusColor =
                item.status === "Disetujui"
                  ? "text-green-600"
                  : item.status === "Ditolak"
                  ? "text-red-600"
                  : "text-yellow-600";
              const itemDiv = document.createElement("div");
              itemDiv.className =
                "bg-white p-4 rounded-lg shadow-md flex justify-between items-center";
              itemDiv.innerHTML = `<div><p class="font-bold">${
                item.event_name
              } (${item.room_name})</p><p class="text-sm ${statusColor}">${
                item.status
              }</p></div>
                        ${
                          item.status === "Menunggu Persetujuan"
                            ? `<button data-id="${item.id}" data-type="room" class="cancel-btn bg-gray-500 text-white py-1 px-3 rounded hover:bg-gray-600">Batalkan</button>`
                            : ""
                        }`;
              listContainer.appendChild(itemDiv);
            });
          } else {
            listContainer.innerHTML +=
              '<p class="text-gray-500">Tidak ada riwayat reservasi ruangan.</p>';
          }
          document
            .querySelectorAll(".cancel-btn")
            .forEach((btn) =>
              btn.addEventListener("click", handleCancelRequest)
            );
        } catch (error) {
          listContainer.innerHTML = `<p class="text-red-500">Gagal memuat data: ${error.message}</p>`;
        }
      }

      async function handleAdminAction(e) {
        const button = e.target;
        const id = button.dataset.id;
        const type = button.dataset.type;
        const action = button.dataset.action;
        if (
          !confirm(
            `Apakah Anda yakin ingin mengubah status permintaan ini menjadi "${action}"?`
          )
        )
          return;
        button.disabled = true;
        button.textContent = "Memproses...";
        try {
          const endpoint = "/api/management";
          const actionPayload =
            type === "loan" ? "updateLoanStatus" : "updateReservationStatus";
          const payload =
            type === "loan"
              ? { loanId: id, newStatus: action }
              : { reservationId: id, newStatus: action };
          await api.post(endpoint, { action: actionPayload, payload: payload });
          alert("Status permintaan berhasil diperbarui.");
          loadDashboardPage();
        } catch (error) {
          alert(`Gagal memperbarui: ${error.message}`);
          button.disabled = false;
          button.textContent = action;
        }
      }

      async function handleCancelRequest(e) {
        const button = e.target;
        const id = button.dataset.id;
        const type = button.dataset.type;
        if (!confirm("Apakah Anda yakin ingin membatalkan permintaan ini?"))
          return;
        button.disabled = true;
        button.textContent = "Memproses...";
        try {
          await api.post("/api/requests/cancel", {
            requestId: id,
            requestType: type,
          });
          alert("Permintaan berhasil dibatalkan.");
          loadDashboardPage();
        } catch (error) {
          alert(`Gagal membatalkan: ${error.message}`);
          button.disabled = false;
          button.textContent = "Batalkan";
        }
      }

      async function loadBarangPage() {
        showLoader();
        try {
          const template = document
            .getElementById("barang-template")
            .content.cloneNode(true);
          contentArea.appendChild(template);
          await renderBarangListView();
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Terjadi error saat memuat halaman barang: ${error.message}</p>`;
        } finally {
          hideLoader();
        }
      }

      async function renderBarangListView() {
        const container = document.getElementById("barang-content-area");
        try {
          const assets = await api.get("/api/assets");
          let cardsHTML =
            '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
          assets.forEach((asset) => {
            cardsHTML += `<div data-id="${
              asset.id
            }" class="asset-card bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
                    <img src="${
                      asset.photo_url ||
                      "https://placehold.co/600x400/EEE/31343C?text=Aset"
                    }" class="w-full h-40 object-cover rounded-md mb-3">
                    <h3 class="font-bold text-lg">${asset.asset_name}</h3>
                    <p class="text-sm text-gray-500">${asset.location}</p>
                </div>`;
          });
          cardsHTML += "</div>";
          container.innerHTML = cardsHTML;
          document.querySelectorAll(".asset-card").forEach((card) => {
            card.addEventListener("click", () => {
              const assetId = card.dataset.id;
              renderBarangDetailView(assetId);
            });
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat barang: ${error.message}</p>`;
        }
      }

      async function renderBarangDetailView(assetId) {
        const container = document.getElementById("barang-content-area");
        container.innerHTML = `<p>Memuat detail dan jadwal untuk aset...</p>`;
        try {
          const [assets, schedule] = await Promise.all([
            api.get("/api/assets"),
            api.get(`/api/assets/${assetId}/schedule`),
          ]);
          const asset = assets.find((a) => a.id === assetId);
          if (!asset) {
            container.innerHTML =
              '<p class="text-red-500">Aset tidak ditemukan.</p>';
            return;
          }
          const calendarEvents = schedule.map((loan) => ({
            title: `Dipinjam oleh ${loan.profiles.full_name}`,
            start: loan.loan_date,
            end: loan.due_date,
            allDay: !(
              new Date(loan.due_date).getTime() -
                new Date(loan.loan_date).getTime() <
              86400000
            ),
          }));
          container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md">
                <button id="back-to-list-btn" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Kembali ke Daftar</button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <img src="${
                          asset.photo_url ||
                          "https://placehold.co/600x400/EEE/31343C?text=Aset"
                        }" class="w-full h-auto object-cover rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mt-4">${
                          asset.asset_name
                        }</h2>
                        <p class="text-gray-600">${
                          asset.description || "Tidak ada deskripsi."
                        }</p>
                        <p class="mt-2"><i class="fas fa-map-marker-alt w-5"></i> ${
                          asset.location
                        }</p>
                        <div id="borrow-section-container" class="mt-6"></div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-xl font-semibold mb-2">Kalender Peminjaman</h3>
                        <div id="detail-calendar" class="w-full h-full"></div>
                    </div>
                </div>
            </div>`;
          const calendarEl = document.getElementById("detail-calendar");
          if (fullCalendarInstance) fullCalendarInstance.destroy();
          fullCalendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "dayGridMonth,timeGridWeek",
            },
            locale: "id",
            events: calendarEvents,
            eventDidMount: function (info) {
              info.el.title = info.event.title;
            },
          });
          fullCalendarInstance.render();
          document
            .getElementById("back-to-list-btn")
            .addEventListener("click", renderBarangListView);
          const borrowContainer = document.getElementById(
            "borrow-section-container"
          );
          if (localStorage.getItem("userRole") === "member") {
            borrowContainer.innerHTML = `<button id="show-borrow-form-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Pinjam Barang Ini</button>
                <form id="detail-borrow-form" class="hidden mt-4 space-y-4">
                    <div><label for="loan_date" class="block text-sm font-medium text-gray-700">Waktu Pinjam</label><input type="datetime-local" id="loan_date" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <div><label for="due_date" class="block text-sm font-medium text-gray-700">Waktu Kembali</label><input type="datetime-local" id="due_date" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">Kirim Permintaan</button>
                    <p id="detail-borrow-feedback" class="text-center font-semibold"></p>
                </form>`;
            const showFormBtn = document.getElementById("show-borrow-form-btn");
            const detailBorrowForm =
              document.getElementById("detail-borrow-form");
            showFormBtn.addEventListener("click", () => {
              detailBorrowForm.classList.remove("hidden");
              showFormBtn.classList.add("hidden");
            });
            detailBorrowForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const feedback = document.getElementById(
                "detail-borrow-feedback"
              );
              feedback.textContent = "Mengirim...";
              feedback.className = "text-center font-semibold text-blue-600";
              try {
                await api.post("/api/assets", {
                  asset_id: assetId,
                  loan_date: document.getElementById("loan_date").value,
                  due_date: document.getElementById("due_date").value,
                });
                feedback.textContent = "Permintaan berhasil dikirim!";
                feedback.className = "text-center font-semibold text-green-600";
                detailBorrowForm.reset();
                renderBarangDetailView(assetId);
              } catch (error) {
                feedback.textContent = `Gagal: ${error.message}`;
                feedback.className = "text-center font-semibold text-red-600";
              }
            });
          }
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat detail barang: ${error.message}</p>`;
        }
      }

      async function loadRuanganPage() {
        showLoader();
        try {
          const template = document
            .getElementById("ruangan-template")
            .content.cloneNode(true);
          contentArea.appendChild(template);
          const container = document.getElementById("ruangan-content-area");
          if (localStorage.getItem("userRole") === "management") {
            await renderRuanganManagementView(container);
          } else {
            await renderRuanganListView();
          }
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Terjadi error saat memuat halaman ruangan: ${error.message}</p>`;
        } finally {
          hideLoader();
        }
      }

      async function renderRuanganManagementView(container) {
        container.innerHTML = `<p>Memuat data manajemen ruangan...</p>`;
        try {
          const [rooms, users] = await Promise.all([
            api.post("/api/management", { action: "getRooms" }),
            api.post("/api/management", { action: "getUsers" }),
          ]);
          const managementUsers = users.filter((u) => u.role === "management");
          const managerOptionsHTML = managementUsers
            .map((m) => `<option value="${m.id}">${m.full_name}</option>`)
            .join("");

          container.innerHTML = `<div class="flex justify-end mb-4"><button id="add-room-btn" class="bg-[#d97706] text-white font-bold py-2 px-4 rounded-md hover:bg-[#b46504]"><i class="fas fa-plus mr-2"></i>Tambah Ruangan</button></div>
            <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full"><thead class="bg-gray-100"><tr><th class="text-left p-3">Nama Ruangan</th><th class="text-left p-3">Lokasi</th><th class="text-left p-3">Kapasitas</th><th class="text-left p-3">Penanggung Jawab</th><th class="text-center p-3">Aksi</th></tr></thead>
                <tbody id="room-table-body">${rooms
                  .map(
                    (room) => `
                    <tr class="border-b">
                        <td class="p-3">${room.name}</td>
                        <td class="p-3">${room.lokasi || "-"}</td>
                        <td class="p-3">${room.kapasitas || "-"}</td>
                        <td class="p-3">${
                          room.penanggung_jawab?.full_name ||
                          "<i>Belum diatur</i>"
                        }</td>
                        <td class="p-3 whitespace-nowrap text-center">
                            <div class="relative inline-block">
                                <div>
                                    <button type="button" class="action-menu-btn inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none" id="menu-button-${
                                      room.id
                                    }">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                                <div id="action-menu-${
                                  room.id
                                }" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" role="menu">
                                    <div class="py-1" role="none">
                                        <a href="#" data-room='${JSON.stringify(
                                          room
                                        )}' class="edit-room-link text-blue-600 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Edit</a>
                                        <a href="#" data-name="${
                                          room.name
                                        }" class="view-schedule-link text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Lihat Jadwal</a>
                                        <a href="#" data-id="${
                                          room.id
                                        }" class="delete-room-link text-red-600 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">Hapus</a>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>`
                  )
                  .join("")}
                </tbody></table>
            </div>`;

          document
            .getElementById("add-room-btn")
            .addEventListener("click", () =>
              openRoomModal("create", {}, managerOptionsHTML)
            );

          container.addEventListener("click", (e) => {
            const target = e.target;
            const actionButton = target.closest(".action-menu-btn");

            if (actionButton) {
              const menuId = actionButton.id.replace(
                "menu-button-",
                "action-menu-"
              );
              const menu = document.getElementById(menuId);

              if (menu) {
                const isHidden = menu.classList.contains("hidden");

                document
                  .querySelectorAll('[id^="action-menu-"]')
                  .forEach((m) => {
                    if (m.id !== menuId) {
                      m.classList.add("hidden");
                    }
                  });

                menu.classList.toggle("hidden");

                if (!menu.classList.contains("hidden")) {
                  const buttonRect = actionButton.getBoundingClientRect();
                  const menuRect = menu.getBoundingClientRect();

                  menu.classList.remove(
                    "bottom-full",
                    "origin-bottom-right",
                    "mb-2"
                  );
                  menu.classList.add("origin-top-right", "mt-2");

                  if (
                    buttonRect.bottom + menuRect.height >
                    window.innerHeight
                  ) {
                    menu.classList.remove("origin-top-right", "mt-2");
                    menu.classList.add(
                      "bottom-full",
                      "origin-bottom-right",
                      "mb-2"
                    );
                  }
                }
              }
            } else if (!target.closest('[id^="action-menu-"]')) {
              document
                .querySelectorAll('[id^="action-menu-"]')
                .forEach((menu) => menu.classList.add("hidden"));
            }

            const editLink = target.closest(".edit-room-link");
            if (editLink) {
              e.preventDefault();
              openRoomModal(
                "edit",
                JSON.parse(editLink.dataset.room),
                managerOptionsHTML
              );
            }

            const deleteLink = target.closest(".delete-room-link");
            if (deleteLink) {
              e.preventDefault();
              const roomId = deleteLink.dataset.id;
              if (confirm("Apakah Anda yakin ingin menghapus ruangan ini?")) {
                api
                  .post("/api/management", {
                    action: "deleteRoom",
                    payload: { roomId },
                  })
                  .then((res) => {
                    alert(res.message);
                    renderRuanganManagementView(container);
                  })
                  .catch((err) => alert(`Gagal menghapus: ${err.message}`));
              }
            }

            const viewScheduleLink = target.closest(".view-schedule-link");
            if (viewScheduleLink) {
              e.preventDefault();
              renderRuanganScheduleView_Management(
                viewScheduleLink.dataset.name
              );
            }
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat data: ${error.message}</p>`;
        }
      }

      async function renderRuanganListView() {
        const container = document.getElementById("ruangan-content-area");
        container.innerHTML = `<p>Memuat daftar ruangan...</p>`;
        try {
          const rooms = await api.get("/api/rooms");
          let listHTML = '<div class="space-y-4">';
          rooms.forEach((room) => {
            listHTML += `<div data-name="${room.name}" class="room-item bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow flex items-center"><i class="fas fa-building text-2xl text-gray-400 mr-4"></i><h3 class="font-bold text-lg">${room.name}</h3></div>`;
          });
          listHTML += "</div>";
          container.innerHTML = listHTML;
          document.querySelectorAll(".room-item").forEach((item) => {
            item.addEventListener("click", () => {
              const roomName = item.dataset.name;
              renderRuanganDetailView(roomName);
            });
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat ruangan: ${error.message}</p>`;
        }
      }

      async function renderRuanganDetailView(roomName) {
        const container = document.getElementById("ruangan-content-area");
        container.innerHTML = `<p>Memuat detail dan jadwal untuk ${roomName}...</p>`;
        try {
          const schedule = await api.get(
            `/api/rooms/${encodeURIComponent(roomName)}/schedule`
          );
          const calendarEvents = schedule.map((reservation) => ({
            title: reservation.event_name,
            start: reservation.start_time,
            end: reservation.end_time,
            backgroundColor: "#3b82f6",
            borderColor: "#3b82f6",
          }));
          container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md">
                <button id="back-to-room-list-btn" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Kembali ke Daftar Ruangan</button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1"><h2 class="text-2xl font-bold">${roomName}</h2><p class="text-gray-600 mt-2">Gunakan kalender di sebelah kanan untuk melihat jadwal yang sudah terisi.</p><div id="reservation-section-container" class="mt-6"></div></div>
                    <div class="md:col-span-2"><h3 class="text-xl font-semibold mb-2">Kalender Reservasi</h3><div id="detail-calendar" class="w-full h-full"></div></div>
                </div></div>`;
          const calendarEl = document.getElementById("detail-calendar");
          if (fullCalendarInstance) fullCalendarInstance.destroy();
          fullCalendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: "timeGridWeek",
            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "dayGridMonth,timeGridWeek,timeGridDay",
            },
            locale: "id",
            events: calendarEvents,
            eventDidMount: function (info) {
              info.el.title = info.event.title;
            },
          });
          fullCalendarInstance.render();
          document
            .getElementById("back-to-room-list-btn")
            .addEventListener("click", renderRuanganListView);
          const reservationContainer = document.getElementById(
            "reservation-section-container"
          );
          if (localStorage.getItem("userRole") === "member") {
            reservationContainer.innerHTML = `<button id="show-reservation-form-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Reservasi Ruangan Ini</button>
                <form id="detail-reservation-form" class="hidden mt-4 space-y-4">
                    <div><label for="res-event-name" class="block text-sm font-medium text-gray-700">Nama Kegiatan</label><input type="text" id="res-event-name" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <div><label for="res-start-time" class="block text-sm font-medium text-gray-700">Waktu Mulai</label><input type="datetime-local" id="res-start-time" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <div><label for="res-end-time" class="block text-sm font-medium text-gray-700">Waktu Selesai</label><input type="datetime-local" id="res-end-time" required class="w-full p-2 border border-gray-300 rounded-md"></div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">Kirim Permintaan</button>
                    <p id="detail-reservation-feedback" class="text-center font-semibold"></p>
                </form>`;
            const showFormBtn = document.getElementById(
              "show-reservation-form-btn"
            );
            const detailReservationForm = document.getElementById(
              "detail-reservation-form"
            );
            showFormBtn.addEventListener("click", () => {
              detailReservationForm.classList.remove("hidden");
              showFormBtn.classList.add("hidden");
            });
            detailReservationForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const feedback = document.getElementById(
                "detail-reservation-feedback"
              );
              feedback.textContent = "Mengirim...";
              feedback.className = "text-center font-semibold text-blue-600";
              try {
                await api.post("/api/rooms", {
                  room_name: roomName,
                  event_name: document.getElementById("res-event-name").value,
                  start_time: document.getElementById("res-start-time").value,
                  end_time: document.getElementById("res-end-time").value,
                });
                feedback.textContent = "Permintaan berhasil dikirim!";
                feedback.className = "text-center font-semibold text-green-600";
                detailReservationForm.reset();
                renderRuanganDetailView(roomName);
              } catch (error) {
                feedback.textContent = `Gagal: ${error.message}`;
                feedback.className = "text-center font-semibold text-red-600";
              }
            });
          }
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat detail ruangan: ${error.message}</p>`;
        }
      }

      async function renderRuanganScheduleView_Management(roomName) {
        const container = document.getElementById("ruangan-content-area");
        container.innerHTML = `<p>Memuat jadwal untuk ${roomName}...</p>`;
        showLoader();

        try {
          const schedule = await api.get(
            `/api/rooms/${encodeURIComponent(roomName)}/schedule`
          );
          const calendarEvents = schedule.map((reservation) => ({
            title: reservation.event_name,
            start: reservation.start_time,
            end: reservation.end_time,
            backgroundColor: "#3b82f6",
            borderColor: "#3b82f6",
          }));

          container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="back-to-management-view-btn" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Kembali ke Manajemen Ruangan</button>
                    <h2 class="text-2xl font-bold mb-4">Jadwal untuk ${roomName}</h2>
                    <div id="management-schedule-calendar" class="w-full h-full"></div>
                </div>
            `;

          const calendarEl = document.getElementById(
            "management-schedule-calendar"
          );
          if (fullCalendarInstance) {
            fullCalendarInstance.destroy();
          }
          fullCalendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: "timeGridWeek",
            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "dayGridMonth,timeGridWeek,timeGridDay",
            },
            locale: "id",
            events: calendarEvents,
            eventDidMount: function (info) {
              info.el.title = info.event.title;
            },
          });
          fullCalendarInstance.render();

          document
            .getElementById("back-to-management-view-btn")
            .addEventListener("click", loadRuanganPage);
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat jadwal: ${error.message}</p>`;
        } finally {
          hideLoader();
        }
      }

      function openRoomModal(mode, roomData = {}, managerOptionsHTML) {
        const modal = document.getElementById("room-modal");
        const form = document.getElementById("room-modal-form");
        form.reset();
        document.getElementById("room-modal-feedback").textContent = "";
        const pjSelect = document.getElementById("room-penanggung-jawab");
        pjSelect.innerHTML = `<option value="">-- Pilih Penanggung Jawab --</option>${managerOptionsHTML}`;
        if (mode === "edit") {
          document.getElementById("room-modal-title").textContent =
            "Edit Ruangan";
          document.getElementById("room-id").value = roomData.id;
          document.getElementById("room-name").value = roomData.name;
          document.getElementById("room-lokasi").value = roomData.lokasi || "";
          document.getElementById("room-kapasitas").value =
            roomData.kapasitas || "";
          pjSelect.value = roomData.penanggung_jawab?.id || "";
        } else {
          document.getElementById("room-modal-title").textContent =
            "Tambah Ruangan Baru";
          document.getElementById("room-id").value = "";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeRoomModal() {
        document.getElementById("room-modal").classList.add("hidden");
        document.getElementById("room-modal").classList.remove("flex");
      }

      async function handleRoomFormSubmit(e) {
        e.preventDefault();
        const feedback = document.getElementById("room-modal-feedback");
        const button = e.target.querySelector('button[type="submit"]');
        button.disabled = true;
        feedback.textContent = "Menyimpan...";
        const roomId = document.getElementById("room-id").value;
        const action = roomId ? "updateRoom" : "createRoom";
        const payload = {
          name: document.getElementById("room-name").value,
          lokasi: document.getElementById("room-lokasi").value,
          kapasitas:
            parseInt(document.getElementById("room-kapasitas").value) || null,
          penanggung_jawab_id: document.getElementById("room-penanggung-jawab")
            .value,
        };
        if (!payload.penanggung_jawab_id) {
          feedback.textContent = "Error: Penanggung Jawab wajib dipilih.";
          button.disabled = false;
          return;
        }
        if (action === "updateRoom") payload.roomId = roomId;
        try {
          const result = await api.post("/api/management", { action, payload });
          alert(result.message);
          closeRoomModal();
          renderRuanganManagementView(
            document.getElementById("ruangan-content-area")
          );
        } catch (error) {
          feedback.textContent = `Error: ${error.message}`;
        } finally {
          button.disabled = false;
        }
      }

      async function loadUserManagementPage() {
        showLoader();
        try {
          const template = document
            .getElementById("user-management-template")
            .content.cloneNode(true);
          contentArea.appendChild(template);
          const container = document.getElementById(
            "user-management-content-area"
          );
          container.innerHTML = `<div class="flex justify-end mb-4"><button id="add-user-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700"><i class="fas fa-plus mr-2"></i>Tambah User Member</button></div>
            <div class="bg-white p-4 rounded-lg shadow-md"><table class="min-w-full"><thead class="bg-gray-100"><tr><th class="text-left p-3">Nama Lengkap</th><th class="text-left p-3">Email</th><th class="text-left p-3">Aksi</th></tr></thead><tbody id="user-table-body"></tbody></table></div>`;
          document
            .getElementById("add-user-btn")
            .addEventListener("click", () => openUserModal("create"));
          await refreshUserTable();
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Terjadi error saat memuat halaman user: ${error.message}</p>`;
        } finally {
          hideLoader();
        }
      }

      async function refreshUserTable() {
        const tableBody = document.getElementById("user-table-body");
        if (!tableBody) return;
        tableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center">Memuat ulang data...</td></tr>`;
        try {
          const users = await api.post("/api/management", {
            action: "getUsers",
          });
          renderUserTable(users);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
        }
      }

      function renderUserTable(users) {
        const tableBody = document.getElementById("user-table-body");
        if (!tableBody) return;
        if (users.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center">Belum ada data pengguna.</td></tr>`;
        } else {
          tableBody.innerHTML = users
            .map(
              (user) => `
                <tr class="border-b"><td class="p-3">${
                  user.full_name || user.email
                }</td><td class="p-3">${
                user.email
              }</td><td class="p-3 whitespace-nowrap">
                <button data-id="${user.id}" data-name="${
                user.full_name
              }" data-email="${
                user.email
              }" class="edit-user-btn text-blue-500 hover:underline mr-4">Edit</button>
                <button data-id="${
                  user.id
                }" class="delete-user-btn text-red-500 hover:underline">Hapus</button></td></tr>`
            )
            .join("");
        }
        document
          .querySelectorAll(".edit-user-btn")
          .forEach((btn) =>
            btn.addEventListener("click", () =>
              openUserModal("edit", {
                id: btn.dataset.id,
                name: btn.dataset.name,
                email: btn.dataset.email,
              })
            )
          );
        document.querySelectorAll(".delete-user-btn").forEach((btn) =>
          btn.addEventListener("click", async () => {
            if (confirm("Apakah Anda yakin ingin menghapus user ini?")) {
              try {
                const res = await api.post("/api/management", {
                  action: "deleteUser",
                  payload: { userId: btn.dataset.id },
                });
                alert(res.message);
                refreshUserTable();
              } catch (err) {
                alert(`Gagal menghapus: ${err.message}`);
              }
            }
          })
        );
      }

      function openUserModal(mode, userData = {}) {
        const modal = document.getElementById("user-modal");
        const form = document.getElementById("user-modal-form");
        form.reset();
        document.getElementById("user-modal-feedback").textContent = "";
        document.getElementById("user-password").placeholder =
          mode === "edit" ? "Kosongkan jika tidak ingin diubah" : "Wajib diisi";
        document.getElementById("user-password").required = mode === "create";
        if (mode === "edit") {
          document.getElementById("user-modal-title").textContent =
            "Edit User Member";
          document.getElementById("user-id").value = userData.id;
          document.getElementById("user-fullname").value = userData.name;
          document.getElementById("user-email").value = userData.email;
        } else {
          document.getElementById("user-modal-title").textContent =
            "Tambah User Member Baru";
          document.getElementById("user-id").value = "";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeUserModal() {
        document.getElementById("user-modal").classList.add("hidden");
        document.getElementById("user-modal").classList.remove("flex");
      }

      async function handleUserFormSubmit(e) {
        e.preventDefault();
        const feedback = document.getElementById("user-modal-feedback");
        feedback.textContent = "Menyimpan...";
        const userId = document.getElementById("user-id").value;
        const mode = userId ? "updateUser" : "createUser";
        const payload = {
          fullName: document.getElementById("user-fullname").value,
          email: document.getElementById("user-email").value,
        };
        const password = document.getElementById("user-password").value;
        if (password) payload.password = password;
        if (mode === "updateUser") payload.userId = userId;
        try {
          const result = await api.post("/api/management", {
            action: mode,
            payload,
          });
          alert(result.message);
          closeUserModal();
          refreshUserTable();
        } catch (error) {
          feedback.textContent = `Error: ${error.message}`;
        }
      }

      // === EVENT LISTENERS ===
      document
        .getElementById("login-form")
        .addEventListener("submit", handleLogin);
      document
        .getElementById("logout-button")
        .addEventListener("click", logout);
      window.addEventListener("hashchange", router);

      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("authToken")) {
          loginScreen.style.display = "none";
          appLayout.classList.remove("hidden");
          if (localStorage.getItem("userRole") === "management") {
            managementLink.classList.remove("hidden");
          }
          updateUserGreeting();
          router();
        }
        hamburgerButton.addEventListener("click", toggleSidebar);
        closeSidebarButton.addEventListener("click", toggleSidebar);
        sidebarOverlay.addEventListener("click", toggleSidebar);
        document
          .getElementById("user-modal-close")
          .addEventListener("click", closeUserModal);
        document
          .getElementById("user-modal-form")
          .addEventListener("submit", handleUserFormSubmit);
        document
          .getElementById("room-modal-close")
          .addEventListener("click", closeRoomModal);
        document
          .getElementById("room-modal-form")
          .addEventListener("submit", handleRoomFormSubmit);
      });
    </script>
  </body>
</html>
