<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard GKI Kutisari</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* GANTI DENGAN BLOK INI */
      #login-video-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw; /* 100% dari lebar viewport */
        height: 100vh; /* 100% dari tinggi viewport */
        object-fit: cover; /* Ini kuncinya: "zoom to fill" */
        z-index: -100;
      }

      .login-form-container {
        background: rgba(
          255,
          255,
          255,
          0.25
        ); /* Latar belakang semi-transparan */
        backdrop-filter: blur(10px); /* Efek blur (glassmorphism) */
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3); /* Garis tepi tipis */
      }
      .modal {
        transition: opacity 0.25s ease;
      }
      /* BARU: CSS untuk Animasi Loading Overlay */
      /* Kita tidak butuh background-particles atau body styling dari file asli Anda */

      .loading-container {
        text-align: center;
        color: white;
      }
      .church-loader {
        width: 120px;
        height: 120px;
        margin: 0 auto 20px;
        position: relative;
        animation: church-pulse 2s ease-in-out infinite;
      }
      @keyframes church-pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      .church-building {
        width: 120px;
        height: 120px;
        position: relative;
        margin: 0 auto;
      }
      .church-base {
        width: 80px;
        height: 60px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 5px;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        animation: building-glow 3s ease-in-out infinite;
      }
      @keyframes building-glow {
        0%,
        100% {
          box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        50% {
          box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
      }
      .church-roof {
        width: 0;
        height: 0;
        border-left: 45px solid transparent;
        border-right: 45px solid transparent;
        border-bottom: 35px solid rgba(255, 255, 255, 0.9);
        position: absolute;
        bottom: 55px;
        left: 50%;
        transform: translateX(-50%);
        animation: roof-bounce 2s ease-in-out infinite;
      }
      @keyframes roof-bounce {
        0%,
        100% {
          transform: translateX(-50%) translateY(0px);
        }
        50% {
          transform: translateX(-50%) translateY(-5px);
        }
      }
      .church-tower {
        width: 30px;
        height: 40px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 3px;
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
      }
      .church-tower-roof {
        width: 0;
        height: 0;
        border-left: 18px solid transparent;
        border-right: 18px solid transparent;
        border-bottom: 20px solid rgba(255, 255, 255, 0.9);
        position: absolute;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
      }
      .church-cross {
        position: absolute;
        bottom: 115px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255, 255, 255, 0.9);
        font-size: 24px;
        animation: cross-glow 2s ease-in-out infinite;
      }
      @keyframes cross-glow {
        0%,
        100% {
          text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
          transform: translateX(-50%) scale(1);
        }
        50% {
          text-shadow: 0 0 20px rgba(255, 255, 255, 1);
          transform: translateX(-50%) scale(1.2);
        }
      }
      .loading-text {
        font-size: 1.8rem;
        font-weight: 600;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        animation: text-fade 2s ease-in-out infinite;
      }
      @keyframes text-fade {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
      .loading-dots {
        margin: 20px 0;
      }
      .dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        margin: 0 3px;
        animation: dot-bounce 1.4s ease-in-out infinite;
      }
      .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes dot-bounce {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.2);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div
      id="login-screen"
      class="relative flex items-center justify-center h-screen overflow-hidden"
    >
      <video autoplay muted loop id="login-video-bg">
        <source src="bg.mp4" type="video/mp4" />
        Browser Anda tidak mendukung tag video.
      </video>

      <div
        class="login-form-container w-full max-w-md p-8 space-y-6 rounded-2xl shadow-lg"
      >
        <div class="text-center">
          <img
            src="logo.png"
            alt="Logo GKI Kutisari"
            class="w-16 h-16 mx-auto mb-4"
          />
          <h2 class="text-2xl font-bold text-gray-900">
            Sistem Informasi GKI Kutisari
          </h2>
        </div>

        <form id="login-form" class="space-y-6">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700"
              >Email</label
            >
            <input
              id="email"
              type="email"
              required
              class="w-full px-4 py-2 mt-1 bg-white/50 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
              value="harisgay@gmail.com"
            />
          </div>
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-gray-700"
              >Password</label
            >
            <input
              id="password"
              type="password"
              required
              class="w-full px-4 py-2 mt-1 bg-white/50 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
              value="123"
            />
          </div>
          <button
            type="submit"
            class="w-full py-3 mt-6 font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition-colors"
          >
            Login
          </button>
          <p
            id="login-feedback"
            class="mt-2 text-sm text-center text-red-700 font-semibold"
          ></p>
        </form>
      </div>
    </div>

    <div id="app-layout" class="hidden">
      <div class="relative min-h-screen md:flex">
        <div
          id="sidebar"
          class="fixed inset-y-0 left-0 w-64 bg-gray-800 text-white flex flex-col transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30"
        >
          <div class="flex items-center px-6 py-6">
            <img
              src="logo.png"
              alt="Logo GKI Kutisari"
              class="h-10 w-10 mr-3"
            />
            <span id="user-greeting" class="text-gray-300"></span>
          </div>
          <nav class="flex-1 px-4 py-4 space-y-2">
            <a
              href="#dashboard"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-tachometer-alt w-6"></i> Dashboard
            </a>
            <a
              href="#barang"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-boxes w-6"></i> Barang
            </a>
            <a
              href="#ruangan"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-building w-6"></i> Ruangan
            </a>
            <a
              href="#user-management"
              id="management-link"
              class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 hidden"
            >
              <i class="fas fa-users-cog w-6"></i> User Management
            </a>
          </nav>
          <div class="p-4 border-t border-gray-700 md:hidden">
            <button
              id="close-sidebar-button"
              class="flex items-center w-full px-4 py-2 text-left rounded-md hover:bg-gray-700"
            >
              <i class="fas fa-times w-6"></i> Tutup Menu
            </button>
          </div>
          <div class="px-4 py-4">
            <a
              href="#"
              id="logout-button"
              class="flex items-center w-full px-4 py-2 text-left rounded-md hover:bg-gray-700"
              ><i class="fas fa-sign-out-alt w-6"></i> Logout</a
            >
          </div>
        </div>
        <div
          id="sidebar-overlay"
          class="fixed inset-0 bg-black opacity-50 hidden z-20"
        ></div>
        <main class="flex-1 p-10 overflow-y-auto">
          <button
            id="hamburger-button"
            class="md:hidden fixed top-4 left-4 z-10 p-2 bg-gray-800 text-white rounded-md"
          >
            <i class="fas fa-bars"></i>
          </button>
          <div id="content-area"></div>
        </main>
      </div>
    </div>

    <template id="dashboard-template">
      <div id="manager-dashboard-content" class="hidden"></div>
      <div id="member-dashboard-content" class="hidden"></div>
    </template>

    <template id="barang-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Peminjaman Barang</h1>
      <div id="barang-content-area">
        <p>Memuat data barang...</p>
      </div>
    </template>

    <template id="ruangan-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Reservasi Ruangan</h1>
      <div id="ruangan-content-area">
        <p>Memuat data ruangan...</p>
      </div>
    </template>

    <template id="user-management-template">
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Manajemen Pengguna</h1>
      <div id="user-management-content-area">
        <p>Memuat data pengguna...</p>
      </div>
    </template>

    <script>
      // === STATE & KONFIGURASI ===
      const contentArea = document.getElementById("content-area");
      const loginScreen = document.getElementById("login-screen");
      const appLayout = document.getElementById("app-layout");
      const managementLink = document.getElementById("management-link");
      const sidebar = document.getElementById("sidebar");
      const hamburgerButton = document.getElementById("hamburger-button");
      const closeSidebarButton = document.getElementById(
        "close-sidebar-button"
      );
      const sidebarOverlay = document.getElementById("sidebar-overlay");
      let fullCalendarInstance; // Global variable for FullCalendar
      let managementUserList = [];

      // === API HELPER (TIDAK BERUBAH) ===
      const api = {
        async _fetch(endpoint, method = "GET", body = null) {
          const token = localStorage.getItem("authToken");
          const options = {
            method,
            headers: { Authorization: `Bearer ${token}` },
          };
          if (body) {
            options.headers["Content-Type"] = "application/json";
            options.body = JSON.stringify(body);
          }
          const response = await fetch(endpoint, options);
          if (response.status === 401) {
            logout();
            return Promise.reject(new Error("Unauthorized"));
          }
          if (response.status === 204) {
            return null;
          }
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "Terjadi kesalahan pada server.");
          }
          return data;
        },
        get(endpoint) {
          return this._fetch(endpoint, "GET");
        },
        post(endpoint, body) {
          return this._fetch(endpoint, "POST", body);
        },
        put(endpoint, body) {
          return this._fetch(endpoint, "PUT", body);
        },
        delete(endpoint, body) {
          return this._fetch(endpoint, "DELETE", body);
        },
        async login(email, password) {
          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error);
          }
          return response.json();
        },
      };

      // BARU: Fungsi untuk mengontrol animasi loading
      const loader = document.getElementById("page-loader");
      function showLoader() {
        if (loader) {
          loader.classList.remove("hidden");
          loader.classList.add("flex");
        }
      }
      function hideLoader() {
        if (loader) {
          loader.classList.add("hidden");
          loader.classList.remove("flex");
        }
      }
      // === FUNGSI UTAMA (AUTH & NAVIGASI) ===
      // BARU: Fungsi untuk menampilkan sapaan kepada user
      function updateUserGreeting() {
        const greetingElement = document.getElementById("user-greeting");
        const userName = localStorage.getItem("userFullName");
        if (greetingElement && userName) {
          // Menggunakan styling yang Anda minta (Nama di-bold)
          greetingElement.innerHTML = `Hi, <strong class="font-bold text-white">${userName}</strong>!`;
        }
      }
      // GANTI FUNGSI LAMA DENGAN VERSI YANG LEBIH BERSIH DAN AMPUH INI
      function logout() {
        // Hapus semua data sesi dari local storage
        localStorage.removeItem("authToken");
        localStorage.removeItem("userRole");
        localStorage.removeItem("userFullName"); // Tambahkan ini untuk kebersihan

        // Cara paling bersih untuk kembali ke halaman login:
        // Muat ulang halaman ke root URL. Ini akan mematikan semua skrip yang berjalan
        // dan mereset state aplikasi ke kondisi awal.
        window.location.replace("/");
      }

      async function handleLogin(e) {
        e.preventDefault();
        const feedback = document.getElementById("login-feedback");
        feedback.textContent = "Mencoba login...";
        try {
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const data = await api.login(email, password);

          localStorage.setItem("authToken", data.session.access_token);
          const userRole = data.user.user_metadata.role || "member";
          localStorage.setItem("userRole", userRole);
          localStorage.setItem(
            "userFullName",
            data.user.full_name || data.user.email
          );

          loginScreen.classList.add("hidden");
          appLayout.classList.remove("hidden");

          if (userRole === "management") {
            managementLink.classList.remove("hidden");
            window.location.hash = "#dashboard";
          } else {
            window.location.hash = "#dashboard"; // Member juga ke dashboard sekarang
          }
          router();
        } catch (error) {
          feedback.textContent = error.message;
        }
      }

      function toggleSidebar() {
        sidebar.classList.toggle("-translate-x-full");
        sidebarOverlay.classList.toggle("hidden");
      }

      // === ROUTER UTAMA (DIPERBARUI) ===
      function router() {
        updateUserGreeting(); // <-- TAMBAHKAN BARIS INI DI SINI
        if (window.innerWidth < 768) {
          sidebar.classList.add("-translate-x-full");
          sidebarOverlay.classList.add("hidden");
        }
        let hash = window.location.hash;
        if (!hash) {
          // Jika tidak ada hash di URL, cek apakah user sudah login
          if (localStorage.getItem("authToken")) {
            // Jika sudah login, arahkan ke dashboard
            hash = "#dashboard";
            window.location.hash = "#dashboard"; // Update URL juga
          } else {
            // Jika tidak login, jangan lakukan apa-apa, biarkan di halaman login
            return;
          }
        }

        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.toggle(
            "bg-gray-700",
            link.getAttribute("href") === hash
          );
        });

        contentArea.innerHTML = ""; // Selalu kosongkan konten sebelum memuat yang baru
        switch (hash) {
          case "#dashboard":
            loadDashboardPage();
            break;
          case "#barang":
            loadBarangPage(); // Akan kita buat nanti
            contentArea.innerHTML =
              "<h1>Halaman Barang (Dalam Pengembangan)</h1>";
            break;
          // GANTI DENGAN KODE INI
          case "#ruangan":
            loadRuanganPage();
            break;
          // GANTI ISI CASE INI
          case "#user-management":
            if (localStorage.getItem("userRole") === "management") {
              loadUserManagementPage(); // <-- Panggil fungsi baru
            } else {
              contentArea.innerHTML = `<h1 class="text-2xl text-red-600">Akses Ditolak</h1>`;
            }
            break;
          default:
            window.location.hash = "#dashboard"; // Arahkan ke dashboard jika hash tidak dikenal
            loadDashboardPage();
        }
      }

      // === FUNGSI PEMUAT HALAMAN (BARU) ===

      // 1. Pemuatan Halaman Dashboard
      // GANTI DENGAN VERSI INI
      async function loadDashboardPage() {
        showLoader(); // Tampilkan animasi
        try {
          const template = document
            .getElementById("dashboard-template")
            .content.cloneNode(true);
          contentArea.innerHTML = ""; // Kosongkan dulu sebelum menempel template
          contentArea.appendChild(template);

          const userRole = localStorage.getItem("userRole");

          if (userRole === "management") {
            document
              .getElementById("manager-dashboard-content")
              .classList.remove("hidden");
            await renderManagerDashboard(); // Tunggu sampai render selesai
          } else {
            document
              .getElementById("member-dashboard-content")
              .classList.remove("hidden");
            await renderMemberDashboard(); // Tunggu sampai render selesai
          }
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Gagal memuat dashboard: ${error.message}</p>`;
        } finally {
          hideLoader(); // Selalu sembunyikan animasi, baik sukses maupun gagal
        }
      }

      // 2. Render Konten Dashboard untuk Management
      // GANTI DENGAN KODE FUNGSI LENGKAP INI
      // GANTI SELURUH FUNGSI LAMA DENGAN VERSI LENGKAP YANG SUDAH DIPERBAIKI INI
      async function renderManagerDashboard() {
        const container = document.getElementById("manager-dashboard-content");
        container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Manajemen</h1><p>Memuat data...</p>`;

        try {
          // Panggil kedua API secara paralel untuk efisiensi
          const [stats, pendingRequests] = await Promise.all([
            api.get("/api/dashboard-stats"),
            api.post("/api/management", { action: "getPendingRequests" }),
          ]);

          // =================================================================
          // ===== PERBAIKAN UTAMA ADA DI DUA BARIS DI BAWAH INI =====
          // Memastikan variabel selalu berupa array, meskipun API mengembalikan null atau undefined
          const pendingAssetLoans = pendingRequests.pendingAssetLoans ?? [];
          const pendingRoomReservations =
            pendingRequests.pendingRoomReservations ?? [];
          // =================================================================

          // Siapkan template HTML untuk seluruh konten dashboard admin
          let contentHTML = `
      <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Manajemen</h1>

      <h2 class="text-xl font-semibold text-gray-700 mb-4">Statistik Aset</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Total Aset</h3><p class="text-3xl font-bold">${stats.totalAssets}</p></div>
          <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Aset Dipinjam</h3><p class="text-3xl font-bold">${stats.borrowedAssets}</p></div>
          <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Dalam Perbaikan</h3><p class="text-3xl font-bold">${stats.maintenanceAssets}</p></div>
      </div>

      <h2 class="text-xl font-semibold text-gray-700 mb-4">Statistik Ruangan</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Total Ruangan</h3><p class="text-3xl font-bold">${stats.totalRooms}</p></div>
          <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Reservasi Disetujui</h3><p class="text-3xl font-bold">${stats.approvedReservations}</p></div>
          <div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-gray-500">Menunggu Persetujuan</h3><p class="text-3xl font-bold">${stats.pendingReservations}</p></div>
      </div>

      <div id="actionable-list-container">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Persetujuan Tertunda</h2>
          <div class="bg-white p-4 rounded-lg shadow-md space-y-4">
    `;

          // Gabungkan dan render daftar permintaan yang pending
          const allPendingRequests = [
            ...pendingAssetLoans.map((item) => ({ ...item, type: "loan" })),
            ...pendingRoomReservations.map((item) => ({
              ...item,
              type: "room",
            })),
          ];

          if (allPendingRequests.length === 0) {
            contentHTML +=
              '<p class="text-gray-500 p-4 text-center">Tidak ada permintaan baru.</p>';
          } else {
            allPendingRequests.forEach((item) => {
              const title =
                item.type === "loan"
                  ? `${item.assets.asset_name}`
                  : `${item.event_name} (${item.room_name})`;
              const requester =
                item.type === "loan"
                  ? item.profiles.full_name
                  : item.requester_name;
              const time =
                item.type === "loan"
                  ? new Date(item.loan_date).toLocaleDateString("id-ID")
                  : new Date(item.start_time).toLocaleString("id-ID");

              contentHTML += `
              <div class="flex items-center justify-between p-4 border rounded-md">
                  <div>
                      <p class="font-semibold">${title}</p>
                      <p class="text-sm text-gray-600">Oleh: ${requester} | Diajukan: ${time}</p>
                  </div>
                  <div class="flex space-x-2">
                      <button data-id="${item.id}" data-type="${item.type}" data-action="Disetujui" class="admin-action-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded">Setujui</button>
                      <button data-id="${item.id}" data-type="${item.type}" data-action="Ditolak" class="admin-action-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded">Tolak</button>
                  </div>
              </div>
          `;
            });
          }

          contentHTML += `</div></div>`; // Tutup div untuk daftar tugas dan container
          container.innerHTML = contentHTML; // Masukkan semua HTML yang sudah jadi ke container

          // Tambahkan event listener untuk semua tombol aksi admin
          document.querySelectorAll(".admin-action-btn").forEach((button) => {
            button.addEventListener("click", handleAdminAction);
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat data dashboard: ${error.message}</p>`;
        }
      }

      // 3. Render Konten Dashboard untuk Member
      async function renderMemberDashboard() {
        const container = document.getElementById("member-dashboard-content");
        container.innerHTML = `
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Status Permintaan Saya</h1>
    <div id="my-requests-list" class="space-y-4">
      <p>Memuat data permintaan...</p>
    </div>
  `;
        const listContainer = document.getElementById("my-requests-list");
        try {
          const { assetLoans, roomReservations } = await api.get(
            "/api/dashboard/my-requests"
          );
          listContainer.innerHTML = "";

          // Render Peminjaman Aset
          listContainer.innerHTML +=
            '<h2 class="text-xl font-semibold mt-4">Peminjaman Barang</h2>';
          if (assetLoans.length > 0) {
            assetLoans.forEach((item) => {
              const statusColor =
                item.status === "Disetujui"
                  ? "text-green-600"
                  : item.status === "Ditolak"
                  ? "text-red-600"
                  : "text-yellow-600";
              const itemDiv = document.createElement("div");
              itemDiv.className =
                "bg-white p-4 rounded-lg shadow-md flex justify-between items-center";
              itemDiv.innerHTML = `
              <div>
                <p class="font-bold">${item.assets.asset_name}</p>
                <p class="text-sm ${statusColor}">${item.status}</p>
              </div>
              ${
                item.status === "Menunggu Persetujuan"
                  ? `<button data-id="${item.id}" data-type="asset" class="cancel-btn bg-gray-500 text-white py-1 px-3 rounded hover:bg-gray-600">Batalkan</button>`
                  : ""
              }
            `;
              listContainer.appendChild(itemDiv);
            });
          } else {
            listContainer.innerHTML +=
              '<p class="text-gray-500">Tidak ada riwayat peminjaman barang.</p>';
          }

          // Render Reservasi Ruangan
          listContainer.innerHTML +=
            '<h2 class="text-xl font-semibold mt-6">Reservasi Ruangan</h2>';
          if (roomReservations.length > 0) {
            roomReservations.forEach((item) => {
              const statusColor =
                item.status === "Disetujui"
                  ? "text-green-600"
                  : item.status === "Ditolak"
                  ? "text-red-600"
                  : "text-yellow-600";
              const itemDiv = document.createElement("div");
              itemDiv.className =
                "bg-white p-4 rounded-lg shadow-md flex justify-between items-center";
              itemDiv.innerHTML = `
              <div>
                <p class="font-bold">${item.event_name} (${item.room_name})</p>
                <p class="text-sm ${statusColor}">${item.status}</p>
              </div>
              ${
                item.status === "Menunggu Persetujuan"
                  ? `<button data-id="${item.id}" data-type="room" class="cancel-btn bg-gray-500 text-white py-1 px-3 rounded hover:bg-gray-600">Batalkan</button>`
                  : ""
              }
            `;
              listContainer.appendChild(itemDiv);
            });
          } else {
            listContainer.innerHTML +=
              '<p class="text-gray-500">Tidak ada riwayat reservasi ruangan.</p>';
          }

          // Tambahkan event listener untuk tombol batal
          document
            .querySelectorAll(".cancel-btn")
            .forEach((btn) =>
              btn.addEventListener("click", handleCancelRequest)
            );
        } catch (error) {
          listContainer.innerHTML = `<p class="text-red-500">Gagal memuat data: ${error.message}</p>`;
        }
      }
      // GANTI FUNGSI LAMA DENGAN VERSI YANG SUDAH DIPERBAIKI INI
      async function handleAdminAction(e) {
        const button = e.target;
        const id = button.dataset.id;
        const type = button.dataset.type; // 'loan' atau 'room'
        const action = button.dataset.action; // 'Disetujui' atau 'Ditolak'

        if (
          !confirm(
            `Apakah Anda yakin ingin mengubah status permintaan ini menjadi "${action}"?`
          )
        )
          return;

        button.disabled = true;
        button.textContent = "Memproses...";

        try {
          const endpoint = "/api/management";

          // Variabel 'action' di sini diganti namanya menjadi 'actionPayload' untuk menghindari duplikasi
          const actionPayload =
            type === "loan" ? "updateLoanStatus" : "updateReservationStatus";

          const payload =
            type === "loan"
              ? { loanId: id, newStatus: action }
              : { reservationId: id, newStatus: action };

          await api.post(endpoint, { action: actionPayload, payload: payload });

          alert("Status permintaan berhasil diperbarui.");
          loadDashboardPage(); // Muat ulang data dashboard
        } catch (error) {
          alert(`Gagal memperbarui: ${error.message}`);
          button.disabled = false;
          button.textContent = action;
        }
      }
      // 4. Fungsi untuk menangani Aksi Pembatalan oleh Member
      async function handleCancelRequest(e) {
        const button = e.target;
        const id = button.dataset.id;
        const type = button.dataset.type;

        if (!confirm("Apakah Anda yakin ingin membatalkan permintaan ini?"))
          return;

        button.disabled = true;
        button.textContent = "Memproses...";

        try {
          await api.post("/api/requests/cancel", {
            requestId: id,
            requestType: type,
          });
          alert("Permintaan berhasil dibatalkan.");
          loadDashboardPage(); // Muat ulang dashboard
        } catch (error) {
          alert(`Gagal membatalkan: ${error.message}`);
          button.disabled = false;
          button.textContent = "Batalkan";
        }
      }

      // =====================================================================
      //          FUNGSI UNTUK HALAMAN BARANG
      // =====================================================================

      async function loadBarangPage() {
        showLoader(); // Tampilkan animasi
        try {
          const template = document
            .getElementById("barang-template")
            .content.cloneNode(true);
          contentArea.appendChild(template);

          // Secara default, tampilkan daftar semua barang
          await renderBarangListView();
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Terjadi error saat memuat halaman barang: ${error.message}</p>`;
        } finally {
          hideLoader(); // Selalu sembunyikan animasi setelah selesai
        }
      }

      // Fungsi untuk menampilkan daftar semua barang dalam bentuk kartu
      async function renderBarangListView() {
        const container = document.getElementById("barang-content-area");
        container.innerHTML = `<p>Memuat daftar barang...</p>`;

        try {
          const assets = await api.get("/api/assets");
          let cardsHTML =
            '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
          assets.forEach((asset) => {
            cardsHTML += `
        <div data-id="${
          asset.id
        }" class="asset-card bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow">
          <img src="${
            asset.photo_url ||
            "https://placehold.co/600x400/EEE/31343C?text=Aset"
          }" class="w-full h-40 object-cover rounded-md mb-3">
          <h3 class="font-bold text-lg">${asset.asset_name}</h3>
          <p class="text-sm text-gray-500">${asset.location}</p>
        </div>
      `;
          });
          cardsHTML += "</div>";
          container.innerHTML = cardsHTML;

          // Tambahkan event listener untuk setiap kartu aset
          document.querySelectorAll(".asset-card").forEach((card) => {
            card.addEventListener("click", () => {
              const assetId = card.dataset.id;
              renderBarangDetailView(assetId); // Pindah ke tampilan detail saat diklik
            });
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat barang: ${error.message}</p>`;
        }
      }

      // GANTI SELURUH FUNGSI INI DENGAN VERSI YANG SUDAH DIPERBAIKI
      async function renderBarangDetailView(assetId) {
        const container = document.getElementById("barang-content-area");
        container.innerHTML = `<p>Memuat detail dan jadwal untuk aset...</p>`; // Tampilkan pesan loading awal

        try {
          // Ambil data detail aset dan jadwalnya secara bersamaan
          const [assets, schedule] = await Promise.all([
            api.get("/api/assets"), // Ambil semua aset untuk mencari detailnya
            api.get(`/api/assets/${assetId}/schedule`), // Ambil jadwal spesifik
          ]);

          const asset = assets.find((a) => a.id === assetId);
          if (!asset) {
            container.innerHTML =
              '<p class="text-red-500">Aset tidak ditemukan.</p>';
            return;
          }

          // Siapkan events untuk FullCalendar
          const calendarEvents = schedule.map((loan) => {
            const title = `Dipinjam oleh ${loan.profiles.full_name}`;
            const isSingleDay =
              new Date(loan.due_date).getTime() -
                new Date(loan.loan_date).getTime() <
              86400000;
            return {
              title: title,
              start: loan.loan_date,
              end: loan.due_date,
              allDay: !isSingleDay,
            };
          });

          // Render HTML untuk tampilan detail SETELAH data asset didapatkan
          container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-md">
                <button id="back-to-list-btn" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Kembali ke Daftar</button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <img src="${
                          asset.photo_url ||
                          "https://placehold.co/600x400/EEE/31343C?text=Aset"
                        }" class="w-full h-auto object-cover rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mt-4">${
                          asset.asset_name
                        }</h2>
                        <p class="text-gray-600">${
                          asset.description || "Tidak ada deskripsi."
                        }</p>
                        <p class="mt-2"><i class="fas fa-map-marker-alt w-5"></i> ${
                          asset.location
                        }</p>
                        <div id="borrow-section-container" class="mt-6"></div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-xl font-semibold mb-2">Kalender Peminjaman</h3>
                        <div id="detail-calendar" class="w-full h-full"></div>
                    </div>
                </div>
            </div>
        `;

          // Inisialisasi FullCalendar
          const calendarEl = document.getElementById("detail-calendar");
          if (fullCalendarInstance) {
            fullCalendarInstance.destroy();
          }
          fullCalendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "dayGridMonth,timeGridWeek",
            },
            locale: "id",
            events: calendarEvents,
            eventDidMount: function (info) {
              info.el.title = info.event.title;
            },
          });
          fullCalendarInstance.render();

          // Tambahkan event listener untuk tombol kembali
          document
            .getElementById("back-to-list-btn")
            .addEventListener("click", renderBarangListView);

          // Logika untuk menampilkan tombol dan form peminjaman
          const borrowContainer = document.getElementById(
            "borrow-section-container"
          );
          if (localStorage.getItem("userRole") === "member") {
            borrowContainer.innerHTML = `
                <button id="show-borrow-form-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Pinjam Barang Ini</button>
                <form id="detail-borrow-form" class="hidden mt-4 space-y-4">
                    <div>
                        <label for="loan_date" class="block text-sm font-medium text-gray-700">Waktu Pinjam</label>
                        <input type="datetime-local" id="loan_date" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="due_date" class="block text-sm font-medium text-gray-700">Waktu Kembali</label>
                        <input type="datetime-local" id="due_date" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">Kirim Permintaan</button>
                    <p id="detail-borrow-feedback" class="text-center font-semibold"></p>
                </form>
            `;

            const showFormBtn = document.getElementById("show-borrow-form-btn");
            const detailBorrowForm =
              document.getElementById("detail-borrow-form");

            showFormBtn.addEventListener("click", () => {
              detailBorrowForm.classList.remove("hidden");
              showFormBtn.classList.add("hidden");
            });

            detailBorrowForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const feedback = document.getElementById(
                "detail-borrow-feedback"
              );
              feedback.textContent = "Mengirim...";
              feedback.className = "text-center font-semibold text-blue-600";

              try {
                await api.post("/api/assets", {
                  asset_id: assetId,
                  loan_date: document.getElementById("loan_date").value,
                  due_date: document.getElementById("due_date").value,
                });
                feedback.textContent = "Permintaan berhasil dikirim!";
                feedback.className = "text-center font-semibold text-green-600";
                detailBorrowForm.reset();
                renderBarangDetailView(assetId);
              } catch (error) {
                feedback.textContent = `Gagal: ${error.message}`;
                feedback.className = "text-center font-semibold text-red-600";
              }
            });
          }
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat detail barang: ${error.message}</p>`;
        }
      }
      // =====================================================================
      //          FUNGSI UNTUK HALAMAN RUANGAN
      // =====================================================================
      // GANTI DENGAN VERSI INI
      async function loadRuanganPage() {
        showLoader(); // Tampilkan animasi
        try {
          const template = document
            .getElementById("ruangan-template")
            .content.cloneNode(true);
          contentArea.appendChild(template);

          const container = document.getElementById("ruangan-content-area");

          if (localStorage.getItem("userRole") === "management") {
            await renderRuanganManagementView(container);
          } else {
            await renderRuanganListView();
          }
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Terjadi error saat memuat halaman ruangan: ${error.message}</p>`;
        } finally {
          hideLoader(); // Selalu sembunyikan animasi setelah selesai
        }
      }

      async function refreshRoomTable() {
        const container = document.getElementById("ruangan-content-area");
        const tableBody = container.querySelector("tbody");
        if (!tableBody) return;

        tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center">Memuat ulang data...</td></tr>`;
        try {
          // Ambil data ruangan dan user management lagi
          const [rooms, users] = await Promise.all([
            api.post("/api/management", { action: "getRooms" }),
            api.post("/api/management", { action: "getUsers" }),
          ]);

          const managementUsers = users.filter((u) => u.role === "management");
          // Simpan lagi ke variabel global untuk konsistensi
          managementUserList = managementUsers;

          // Render tabel dengan data baru
          renderRoomTable(rooms);
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">${error.message}</td></tr>`;
        }
      }

      // GANTI DENGAN VERSI FINAL INI
      async function renderRuanganManagementView(container) {
        container.innerHTML = `<p>Memuat data manajemen ruangan...</p>`;

        try {
          // Ambil data ruangan dan daftar user management secara bersamaan
          const [rooms, users] = await Promise.all([
            api.post("/api/management", { action: "getRooms" }),
            api.post("/api/management", { action: "getUsers" }),
          ]);

          const managementUsers = users.filter((u) => u.role === "management");
          const managerOptionsHTML = managementUsers
            .map((m) => `<option value="${m.id}">${m.full_name}</option>`)
            .join("");

          // Render kerangka HTML dan tabel
          container.innerHTML = `
      <div class="flex justify-end mb-4">
        <button id="add-room-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">
          <i class="fas fa-plus mr-2"></i>Tambah Ruangan
        </button>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left p-3">Nama Ruangan</th><th class="text-left p-3">Lokasi</th>
              <th class="text-left p-3">Kapasitas</th><th class="text-left p-3">Penanggung Jawab</th>
              <th class="text-left p-3">Aksi</th>
            </tr>
          </thead>
          <tbody id="room-table-body">
            ${rooms
              .map(
                (room) => `
              <tr class="border-b">
                <td class="p-3">${room.name}</td>
                <td class="p-3">${room.lokasi || "-"}</td>
                <td class="p-3">${room.kapasitas || "-"}</td>
                <td class="p-3">${
                  room.penanggung_jawab?.full_name || "<i>Belum diatur</i>"
                }</td>
                <td class="p-3 whitespace-nowrap">
                  <button data-room='${JSON.stringify(
                    room
                  )}' class="edit-room-btn text-blue-500 hover:underline mr-4">Edit</button>
                  <button data-id="${
                    room.id
                  }" class="delete-room-btn text-red-500 hover:underline">Hapus</button>
                </td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        </table>
      </div>
    `;

          // --- PASANG EVENT LISTENER DI SINI, SETELAH SEMUA SIAP ---
          document
            .getElementById("add-room-btn")
            .addEventListener("click", () => {
              openRoomModal("create", {}, managerOptionsHTML);
            });

          document.querySelectorAll(".edit-room-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              openRoomModal(
                "edit",
                JSON.parse(btn.dataset.room),
                managerOptionsHTML
              );
            });
          });

          document.querySelectorAll(".delete-room-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const roomId = e.target.dataset.id;
              if (confirm("Apakah Anda yakin ingin menghapus ruangan ini?")) {
                api
                  .post("/api/management", {
                    action: "deleteRoom",
                    payload: { roomId },
                  })
                  .then((res) => {
                    alert(res.message);
                    renderRuanganManagementView(container); // Refresh view
                  })
                  .catch((err) => alert(`Gagal menghapus: ${err.message}`));
              }
            });
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat data: ${error.message}</p>`;
        }
      }

      // Fungsi untuk menampilkan daftar semua ruangan
      async function renderRuanganListView() {
        const container = document.getElementById("ruangan-content-area");
        container.innerHTML = `<p>Memuat daftar ruangan...</p>`;

        try {
          const rooms = await api.get("/api/rooms");
          let listHTML = '<div class="space-y-4">';
          rooms.forEach((room) => {
            listHTML += `
        <div data-name="${room.name}" class="room-item bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow flex items-center">
          <i class="fas fa-building text-2xl text-gray-400 mr-4"></i>
          <h3 class="font-bold text-lg">${room.name}</h3>
        </div>
      `;
          });
          listHTML += "</div>";
          container.innerHTML = listHTML;

          // Tambahkan event listener untuk setiap item ruangan
          document.querySelectorAll(".room-item").forEach((item) => {
            item.addEventListener("click", () => {
              const roomName = item.dataset.name;
              renderRuanganDetailView(roomName); // Pindah ke tampilan detail saat diklik
            });
          });
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat ruangan: ${error.message}</p>`;
        }
      }

      // GANTI SELURUH FUNGSI INI DENGAN VERSI YANG SUDAH LENGKAP
      async function renderRuanganDetailView(roomName) {
        const container = document.getElementById("ruangan-content-area");
        container.innerHTML = `<p>Memuat detail dan jadwal untuk ${roomName}...</p>`;

        try {
          // Ambil jadwal dari API
          const schedule = await api.get(
            `/api/rooms/${encodeURIComponent(roomName)}/schedule`
          );

          // Siapkan events untuk FullCalendar
          const calendarEvents = schedule.map((reservation) => {
            return {
              title: reservation.event_name,
              start: reservation.start_time,
              end: reservation.end_time,
              backgroundColor: "#3b82f6",
              borderColor: "#3b82f6",
            };
          });

          // Render HTML untuk tampilan detail, sekarang dengan placeholder untuk form
          container.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-md">
                <button id="back-to-room-list-btn" class="mb-4 text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Kembali ke Daftar Ruangan</button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1">
                        <h2 class="text-2xl font-bold">${roomName}</h2>
                        <p class="text-gray-600 mt-2">Gunakan kalender di sebelah kanan untuk melihat jadwal yang sudah terisi.</p>

                        <div id="reservation-section-container" class="mt-6"></div>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-xl font-semibold mb-2">Kalender Reservasi</h3>
                        <div id="detail-calendar" class="w-full h-full"></div>
                    </div>
                </div>
            </div>
        `;

          // Inisialisasi FullCalendar
          const calendarEl = document.getElementById("detail-calendar");
          if (fullCalendarInstance) {
            fullCalendarInstance.destroy();
          }
          fullCalendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: "timeGridWeek",
            headerToolbar: {
              left: "prev,next today",
              center: "title",
              right: "dayGridMonth,timeGridWeek,timeGridDay",
            },
            locale: "id",
            events: calendarEvents,
            eventDidMount: function (info) {
              info.el.title = info.event.title;
            },
          });
          fullCalendarInstance.render();

          // Tambahkan event listener untuk tombol kembali
          document
            .getElementById("back-to-room-list-btn")
            .addEventListener("click", renderRuanganListView);

          // BARU: Logika untuk menampilkan tombol dan form reservasi
          const reservationContainer = document.getElementById(
            "reservation-section-container"
          );
          if (localStorage.getItem("userRole") === "member") {
            reservationContainer.innerHTML = `
                <button id="show-reservation-form-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Reservasi Ruangan Ini</button>
                <form id="detail-reservation-form" class="hidden mt-4 space-y-4">
                    <div>
                        <label for="res-event-name" class="block text-sm font-medium text-gray-700">Nama Kegiatan</label>
                        <input type="text" id="res-event-name" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="res-start-time" class="block text-sm font-medium text-gray-700">Waktu Mulai</label>
                        <input type="datetime-local" id="res-start-time" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="res-end-time" class="block text-sm font-medium text-gray-700">Waktu Selesai</label>
                        <input type="datetime-local" id="res-end-time" required class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700">Kirim Permintaan</button>
                    <p id="detail-reservation-feedback" class="text-center font-semibold"></p>
                </form>
            `;

            const showFormBtn = document.getElementById(
              "show-reservation-form-btn"
            );
            const detailReservationForm = document.getElementById(
              "detail-reservation-form"
            );

            showFormBtn.addEventListener("click", () => {
              detailReservationForm.classList.remove("hidden");
              showFormBtn.classList.add("hidden");
            });

            detailReservationForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              const feedback = document.getElementById(
                "detail-reservation-feedback"
              );
              feedback.textContent = "Mengirim...";
              feedback.className = "text-center font-semibold text-blue-600";

              try {
                await api.post("/api/rooms", {
                  room_name: roomName,
                  event_name: document.getElementById("res-event-name").value,
                  start_time: document.getElementById("res-start-time").value,
                  end_time: document.getElementById("res-end-time").value,
                });
                feedback.textContent = "Permintaan berhasil dikirim!";
                feedback.className = "text-center font-semibold text-green-600";
                detailReservationForm.reset();
                renderRuanganDetailView(roomName);
              } catch (error) {
                feedback.textContent = `Gagal: ${error.message}`;
                feedback.className = "text-center font-semibold text-red-600";
              }
            });
          }
        } catch (error) {
          container.innerHTML = `<p class="text-red-500">Gagal memuat detail ruangan: ${error.message}</p>`;
        }
      }
      // GANTI DENGAN VERSI LENGKAP INI
      function openRoomModal(mode, roomData = {}, managerOptionsHTML) {
        const modal = document.getElementById("room-modal");
        const form = document.getElementById("room-modal-form");
        form.reset();
        document.getElementById("room-modal-feedback").textContent = "";

        const pjSelect = document.getElementById("room-penanggung-jawab");
        // Mengisi dropdown dengan daftar manajer
        pjSelect.innerHTML = `<option value="">-- Pilih Penanggung Jawab --</option>${managerOptionsHTML}`;

        if (mode === "edit") {
          document.getElementById("room-modal-title").textContent =
            "Edit Ruangan";
          document.getElementById("room-id").value = roomData.id;
          document.getElementById("room-name").value = roomData.name;
          document.getElementById("room-lokasi").value = roomData.lokasi || "";
          document.getElementById("room-kapasitas").value =
            roomData.kapasitas || "";
          // Set nilai dropdown sesuai data yang ada
          pjSelect.value = roomData.penanggung_jawab?.id || "";
        } else {
          document.getElementById("room-modal-title").textContent =
            "Tambah Ruangan Baru";
          document.getElementById("room-id").value = "";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      // TAMBAHKAN DUA FUNGSI BARU INI

      function closeRoomModal() {
        document.getElementById("room-modal").classList.add("hidden");

        document.getElementById("room-modal").classList.remove("flex");
      }

      // GANTI DENGAN VERSI LENGKAP INI
      async function handleRoomFormSubmit(e) {
        e.preventDefault();
        const feedback = document.getElementById("room-modal-feedback");
        const button = e.target.querySelector('button[type="submit"]');
        button.disabled = true;
        feedback.textContent = "Menyimpan...";

        const roomId = document.getElementById("room-id").value;
        const action = roomId ? "updateRoom" : "createRoom";

        // Ambil semua data dari form, termasuk UUID penanggung jawab yang dipilih
        const payload = {
          name: document.getElementById("room-name").value,
          lokasi: document.getElementById("room-lokasi").value,
          kapasitas:
            parseInt(document.getElementById("room-kapasitas").value) || null,
          penanggung_jawab_id: document.getElementById("room-penanggung-jawab")
            .value,
        };

        if (!payload.penanggung_jawab_id) {
          feedback.textContent = "Error: Penanggung Jawab wajib dipilih.";
          button.disabled = false;
          return;
        }

        if (action === "updateRoom") {
          payload.roomId = roomId;
        }

        try {
          const result = await api.post("/api/management", { action, payload });
          alert(result.message);
          closeRoomModal();
          // Panggil fungsi render ulang untuk refresh tabel
          renderRuanganManagementView(
            document.getElementById("ruangan-content-area")
          );
        } catch (error) {
          feedback.textContent = `Error: ${error.message}`;
        } finally {
          button.disabled = false;
        }
      }
      // =====================================================================
      //          FUNGSI UNTUK HALAMAN USER MANAGEMENT
      // =====================================================================

      // =====================================================================
      //          FUNGSI UNTUK HALAMAN USER MANAGEMENT (VERSI BENAR)
      // =====================================================================

      async function refreshUserTable() {
        console.log("refreshUserTable dipanggil");
        const tableBody = document.getElementById("user-table-body");
        if (!tableBody) {
          console.error("Elemen 'user-table-body' tidak ditemukan di DOM");
          return;
        }

        tableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center">Memuat ulang data...</td></tr>`;
        try {
          console.log("Mengambil data pengguna dari API...");
          const users = await api.post("/api/management", {
            action: "getUsers",
          });
          console.log("Data pengguna diterima:", users);
          renderUserTable(users);
        } catch (error) {
          console.error("Gagal memuat data pengguna:", error);
          tableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
        }
      }

      // GANTI DENGAN VERSI INI
      async function loadUserManagementPage() {
        showLoader(); // Tampilkan animasi
        try {
          const template = document
            .getElementById("user-management-template")
            .content.cloneNode(true);
          contentArea.appendChild(template);

          // Panggil fungsi untuk membangun kerangka dan mengisi data
          await refreshUserTable();

          // Pasang listener untuk tombol tambah user
          document
            .getElementById("add-user-btn")
            .addEventListener("click", () => {
              openUserModal("create");
            });
        } catch (error) {
          contentArea.innerHTML = `<p class="text-red-500">Terjadi error saat memuat halaman user: ${error.message}</p>`;
        } finally {
          hideLoader(); // Selalu sembunyikan animasi setelah selesai
        }
      }
      // TAMBAHKAN KEMBALI FUNGSI INI
      function renderRoomTable(rooms) {
        const tableBody = document.getElementById("room-table-body");
        if (!tableBody) return;

        if (rooms.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center">Belum ada data ruangan.</td></tr>`;
        } else {
          tableBody.innerHTML = rooms
            .map(
              (room) => `
            <tr class="border-b">
                <td class="p-3">${room.name}</td>
                <td class="p-3">${room.lokasi || "-"}</td>
                <td class="p-3">${room.kapasitas || "-"}</td>
                <td class="p-3">${
                  room.penanggung_jawab?.full_name || "<i>Belum diatur</i>"
                }</td>
                <td class="p-3 whitespace-nowrap">
                    <button data-room='${JSON.stringify(
                      room
                    )}' class="edit-room-btn text-blue-500 hover:underline mr-4">Edit</button>
                    <button data-id="${
                      room.id
                    }" class="delete-room-btn text-red-500 hover:underline">Hapus</button>
                </td>
            </tr>
        `
            )
            .join("");
        }
      }

      function renderUserTable(users) {
        const tableBody = document.getElementById("user-table-body");
        if (!tableBody) return;

        if (users.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center">Belum ada data pengguna.</td></tr>`;
        } else {
          tableBody.innerHTML = users
            .map(
              (user) => `
          <tr class="border-b">
            <td class="p-3">${user.full_name || user.email}</td>
            <td class="p-3">${user.email}</td>
            <td class="p-3 whitespace-nowrap">
              <button data-id="${user.id}" data-name="${
                user.full_name
              }" data-email="${
                user.email
              }" class="edit-user-btn text-blue-500 hover:underline mr-4">Edit</button>
              <button data-id="${
                user.id
              }" class="delete-user-btn text-red-500 hover:underline">Hapus</button>
            </td>
          </tr>
        `
            )
            .join("");
        }

        // Pasang event listener untuk tombol edit dan hapus
        document.querySelectorAll(".edit-user-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            openUserModal("edit", {
              id: btn.dataset.id,
              name: btn.dataset.name,
              email: btn.dataset.email,
            })
          );
        });
        document.querySelectorAll(".delete-user-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            if (confirm("Apakah Anda yakin ingin menghapus user ini?")) {
              try {
                const res = await api.post("/api/management", {
                  action: "deleteUser",
                  payload: { userId: btn.dataset.id },
                });
                alert(res.message);
                refreshUserTable();
              } catch (err) {
                alert(`Gagal menghapus: ${err.message}`);
              }
            }
          });
        });
      }

      // Fungsi untuk membuka modal
      function openUserModal(mode, userData = {}) {
        const modal = document.getElementById("user-modal");
        const form = document.getElementById("user-modal-form");
        form.reset();
        document.getElementById("user-modal-feedback").textContent = "";
        document.getElementById("user-password").placeholder =
          mode === "edit" ? "Kosongkan jika tidak ingin diubah" : "Wajib diisi";
        document.getElementById("user-password").required = mode === "create";

        if (mode === "edit") {
          document.getElementById("user-modal-title").textContent =
            "Edit User Member";
          document.getElementById("user-id").value = userData.id;
          document.getElementById("user-fullname").value = userData.name;
          document.getElementById("user-email").value = userData.email;
        } else {
          document.getElementById("user-modal-title").textContent =
            "Tambah User Member Baru";
          document.getElementById("user-id").value = "";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      // Fungsi untuk menutup modal
      function closeUserModal() {
        document.getElementById("user-modal").classList.add("hidden");
        document.getElementById("user-modal").classList.remove("flex");
      }

      // Fungsi untuk menangani submit form
      async function handleUserFormSubmit(e) {
        e.preventDefault();
        const feedback = document.getElementById("user-modal-feedback");
        feedback.textContent = "Menyimpan...";
        const userId = document.getElementById("user-id").value;
        const mode = userId ? "updateUser" : "createUser";

        const payload = {
          fullName: document.getElementById("user-fullname").value,
          email: document.getElementById("user-email").value,
        };
        const password = document.getElementById("user-password").value;
        if (password) {
          payload.password = password;
        }
        if (mode === "updateUser") {
          payload.userId = userId;
        }

        try {
          const result = await api.post("/api/management", {
            action: mode,
            payload,
          });
          alert(result.message);
          closeUserModal();
          refreshUserTable(); // Refresh hanya tabelnya
        } catch (error) {
          feedback.textContent = `Error: ${error.message}`;
        }
      }

      // === EVENT LISTENERS (di bagian akhir skrip) ===
      document
        .getElementById("login-form")
        .addEventListener("submit", handleLogin);
      document
        .getElementById("logout-button")
        .addEventListener("click", logout);
      window.addEventListener("hashchange", router);

      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("authToken")) {
          loginScreen.classList.add("hidden");
          appLayout.classList.remove("hidden");
          if (localStorage.getItem("userRole") === "management") {
            managementLink.classList.remove("hidden");
          }
          updateUserGreeting();
          router();
        }
        hamburgerButton.addEventListener("click", toggleSidebar);
        closeSidebarButton.addEventListener("click", toggleSidebar);
        sidebarOverlay.addEventListener("click", toggleSidebar);
        // GANTI SELURUH BLOK addEventListener('click', ...) LAMA DENGAN INI
        // HAPUS BAGIAN RUANGAN DARI BLOK INI
        document.addEventListener("click", (e) => {
          // Event delegation untuk tombol di tabel user
          if (e.target.matches(".edit-user-btn")) {
            openUserModal("edit", e.target.dataset);
          }
          if (e.target.matches(".delete-user-btn")) {
            if (confirm("Apakah Anda yakin ingin menghapus user ini? ...")) {
              const userId = e.target.dataset.id;
              api
                .post("/api/management", {
                  action: "deleteUser",
                  payload: { userId },
                })
                .then((res) => {
                  alert(res.message);
                  refreshUserTable();
                })
                .catch((err) => alert(`Gagal menghapus: ${err.message}`));
            }
          }
        });

        document
          .getElementById("user-modal-close")
          .addEventListener("click", closeUserModal);
        document
          .getElementById("user-modal-form")
          .addEventListener("submit", handleUserFormSubmit);
        document
          .getElementById("room-modal-close")
          .addEventListener("click", closeRoomModal);
        document
          .getElementById("room-modal-form")
          .addEventListener("submit", handleRoomFormSubmit);
      });
    </script>
    <div
      id="user-modal"
      class="modal fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
        <h2 id="user-modal-title" class="text-2xl font-bold mb-6"></h2>
        <form id="user-modal-form">
          <input type="hidden" id="user-id" />
          <div class="space-y-4">
            <div>
              <label
                for="user-fullname"
                class="block text-sm font-medium text-gray-700"
                >Nama Lengkap</label
              >
              <input
                type="text"
                id="user-fullname"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="user-email"
                class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="user-email"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="user-password"
                class="block text-sm font-medium text-gray-700"
                >Password</label
              >
              <input
                type="password"
                id="user-password"
                class="w-full p-2 border border-gray-300 rounded-md"
                placeholder="Kosongkan jika tidak ingin diubah"
              />
            </div>
          </div>
          <div class="flex justify-end space-x-4 mt-8">
            <button
              type="button"
              id="user-modal-close"
              class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Batal
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Simpan
            </button>
          </div>
          <p
            id="user-modal-feedback"
            class="mt-4 text-center font-semibold"
          ></p>
        </form>
      </div>
    </div>
    <div
      id="room-modal"
      class="modal fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
        <h2 id="room-modal-title" class="text-2xl font-bold mb-6"></h2>
        <form id="room-modal-form">
          <input type="hidden" id="room-id" />
          <div class="space-y-4">
            <div>
              <label
                for="room-name"
                class="block text-sm font-medium text-gray-700"
                >Nama Ruangan</label
              >
              <input
                type="text"
                id="room-name"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="room-lokasi"
                class="block text-sm font-medium text-gray-700"
                >Lokasi</label
              >
              <input
                type="text"
                id="room-lokasi"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="room-kapasitas"
                class="block text-sm font-medium text-gray-700"
                >Kapasitas (Orang)</label
              >
              <input
                type="number"
                id="room-kapasitas"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="room-penanggung-jawab"
                class="block text-sm font-medium text-gray-700"
                >Penanggung Jawab</label
              >
              <select
                id="room-penanggung-jawab"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
              >
                <option value="">Memuat...</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end space-x-4 mt-8">
            <button
              type="button"
              id="room-modal-close"
              class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Batal
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Simpan
            </button>
          </div>
          <p
            id="room-modal-feedback"
            class="mt-4 text-center font-semibold"
          ></p>
        </form>
      </div>
    </div>
    <div
      id="page-loader"
      class="fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center z-50 hidden"
    >
      <div class="loading-container">
        <div class="church-loader">
          <div class="church-building">
            <div class="church-base">
              <div class="church-window"></div>
              <div class="church-window"></div>
              <div class="church-window"></div>
              <div class="church-door"></div>
            </div>
            <div class="church-roof"></div>
            <div class="church-tower"></div>
            <div class="church-tower-roof"></div>
            <div class="church-cross">✠</div>
          </div>
        </div>
        <div class="loading-text">Memuat Data</div>
        <div class="loading-dots">
          <span class="dot"></span><span class="dot"></span
          ><span class="dot"></span>
        </div>
      </div>
    </div>
  </body>
</html>
